<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#667eea">
    <title>图片在线编辑器 - 专业证件照制作</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.12/dist/cropper.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        input, textarea, [contenteditable] {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }
        
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .container {
            width: 100%;
            max-width: 1400px;
            height: 100%;
            background: white;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%, rgba(255,255,255,0.1) 100%);
            pointer-events: none;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        header h1 {
            font-size: 1.8rem;
        }
        
        header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .language-selector {
            position: relative;
            display: inline-block;
            z-index: 9999999 !important;
        }
        
        .language-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .language-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .language-dropdown {
            position: fixed !important;
            top: 80px !important;
            right: 20px !important;
            background: white !important;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3) !important;
            min-width: 200px;
            z-index: 9999999 !important;
            display: none;
            margin-top: 5px;
            border: 2px solid #4b6cb7 !important;
            overflow: visible !important;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 15px 20px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            gap: 10px;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            color: #000 !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            border-bottom: 2px solid #ccc !important;
            background: white !important;
            z-index: 9999999 !important;
            position: relative !important;
        }
        
        .language-option:last-child {
            border-bottom: none;
        }
        
        .language-option:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
        }
        
        .language-option.active {
            background: linear-gradient(135deg, #4b6cb7 0%, #3a5795 100%);
            color: white;
            font-weight: 600;
        }
        
        .flag {
            width: 20px;
            height: 15px;
            border-radius: 2px;
            object-fit: cover;
        }
        
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 300px;
            padding: 15px;
            background: #f8f9fa;
            border-right: 1px solid #eee;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        .editor-area {
            flex: 1;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .preview-and-tools {
            display: flex;
            flex: 1;
            gap: 15px;
            overflow: hidden;
        }
        
        .preview-section {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .tools-section {
            width: 360px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .upload-area {
            border: 2px dashed #4b6cb7;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            flex-shrink: 0;
        }
        
        .upload-area:hover {
            background-color: #f0f5ff;
            transform: translateY(-3px);
        }
        
        .upload-area i {
            font-size: 42px;
            color: #4b6cb7;
            margin-bottom: 12px;
        }
        
        .upload-area h3 {
            margin-bottom: 8px;
        }
        
        .tool-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .tool-section h2 {
            font-size: 1.2rem;
            margin-bottom: 12px;
            color: #4b6cb7;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tool-group {
            margin-bottom: 12px;
        }
        
        .tool-group h3 {
            font-size: 0.95rem;
            margin-bottom: 6px;
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tool-options {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 8px;
        }
        
        .btn {
            padding: 7px 10px;
            background: #4b6cb7;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn:hover {
            background: #3a5795;
            transform: translateY(-2px);
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid #4b6cb7;
            color: #4b6cb7;
        }
        
        .btn-outline:hover {
            background: #f0f5ff;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }
        
        #imagePreview {
            max-width: 100%;
            max-height: 100%;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .placeholder-image {
            width: 100%;
            height: 100%;
            background: #f5f7fa;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 0.95rem;
        }
        
        .placeholder-image i {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }
        
        .format-options {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .format-btn {
            flex: 1;
            padding: 8px;
            text-align: center;
            background: #f0f5ff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .format-btn.active {
            background: #4b6cb7;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .download-btn {
            background: #28a745;
            color: white;
        }
        
        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .reset-btn {
            background: #dc3545;
            color: white;
        }
        
        .reset-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .slider-container {
            margin: 8px 0;
        }
        
        .slider-container label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }
        
        .slider-value {
            color: #4b6cb7;
            font-weight: bold;
        }
        
        .slider {
            width: 100%;
            height: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 5px;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .slider:focus {
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.3);
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #4b6cb7;
            cursor: pointer;
        }
        
        /* 证件照工具样式 */
        .id-photo-tools {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .id-photo-option {
            background: white;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #eee;
            display: flex;
            flex-direction: column;
        }
        
        .id-photo-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: #4b6cb7;
        }
        
        .id-photo-option.active {
            border-color: #4b6cb7;
            background: #f0f5ff;
        }
        
        .id-photo-preview {
            width: 100%;
            height: 90px;
            background: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .id-photo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .id-photo-size {
            font-weight: bold;
            color: #4b6cb7;
            margin-bottom: 4px;
            font-size: 0.95rem;
        }
        
        .id-photo-desc {
            font-size: 0.75rem;
            color: #333;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .id-photo-usage {
            font-size: 0.7rem;
            color: #666;
        }
        
        /* 压缩工具样式 */
        .file-size-preview {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #dee2e6;
            border-radius: 12px;
            padding: 16px;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .size-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .size-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }
        
        .size-label {
            font-weight: 500;
            color: #495057;
            font-size: 0.85rem;
        }
        
        .size-value {
            font-weight: 600;
            color: #007bff;
            font-size: 0.9rem;
        }
        
        .size-bar {
            margin-top: 12px;
        }
        
        .size-bar-bg {
            width: 100%;
            height: 10px;
            background: linear-gradient(90deg, #e9ecef 0%, #dee2e6 100%);
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .size-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #ffc107 50%, #dc3545 100%);
            border-radius: 5px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .size-bar-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 2px;
            height: 100%;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }
        
        .size-bar-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 0.75rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .id-photo-controls {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
        
        .id-photo-controls .btn {
            flex: 1;
        }
        
        .filter-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .filter-options.advanced {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .filter-option {
            padding: 8px;
            text-align: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #eee;
        }
        
        .filter-option:hover {
            background: #f0f5ff;
        }
        
        .filter-option.active {
            background: #4b6cb7;
            color: white;
            border-color: #4b6cb7;
        }
        
        .filter-preview {
            width: 100%;
            height: 45px;
            border-radius: 5px;
            margin-bottom: 4px;
            background-size: cover;
            background-position: center;
        }
        
        .bg-color-picker {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .bg-color-option {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .bg-color-option.active {
            border-color: #333;
        }
        
        footer {
            text-align: center;
            padding: 12px;
            color: #666;
            font-size: 0.75rem;
            border-top: 1px solid #eee;
            background: #f8f9fa;
            flex-shrink: 0;
        }
        
        .notification {
            position: fixed;
            top: 15px;
            right: 15px;
            padding: 10px 15px;
            background: #28a745;
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .cropper-container {
            max-width: 100%;
            max-height: 100%;
        }
        
        /* 大屏幕优化 */
        @media (max-width: 1400px) {
            .tools-section {
                width: 320px;
            }
            
            .sidebar {
                width: 280px;
            }
        }
        
        /* 中等屏幕 - 平板横屏 */
        @media (max-width: 1200px) {
            .preview-and-tools {
                flex-direction: column;
            }
            
            .tools-section {
                width: 100%;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .id-photo-tools {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .container {
                margin: 10px;
                border-radius: 15px;
            }
        }
        
        /* 平板竖屏 */
        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #eee;
                max-height: 300px;
                overflow-y: auto;
            }
            
            .id-photo-tools {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .filter-options {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .container {
                margin: 5px;
                border-radius: 10px;
            }
            
            header {
                padding: 15px 20px;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            .editor-area {
                padding: 10px;
            }
        }
        
        /* 手机横屏 */
        @media (max-width: 768px) {
            .id-photo-tools {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-options.advanced {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tool-options {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .btn {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .action-btn {
                padding: 8px;
                font-size: 0.8rem;
            }
            
            .format-btn {
                padding: 6px;
                font-size: 0.8rem;
            }
            
            .slider-container label {
                font-size: 0.8rem;
            }
            
            .tool-section h2 {
                font-size: 1.1rem;
            }
            
            .tool-group h3 {
                font-size: 0.9rem;
            }
            
            .id-photo-desc {
                font-size: 0.7rem;
            }
            
            .id-photo-usage {
                font-size: 0.65rem;
            }
        }
        
        /* 手机竖屏 */
        @media (max-width: 576px) {
            body {
                padding: 0;
                margin: 0;
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }
            
            .container {
                margin: 0;
                border-radius: 0;
                height: 100vh;
                min-height: 100vh;
                height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
            }
            
            header {
                padding: 12px 15px;
                border-radius: 0;
            }
            
            header h1 {
                font-size: 1.3rem;
            }
            
            header p {
                font-size: 0.8rem;
            }
            
            .logo i {
                font-size: 1.5rem;
            }
            
            .header-actions {
                gap: 8px;
            }
            
            .language-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .sidebar {
                padding: 10px;
                max-height: 250px;
                order: 2;
            }
            
            .editor-area {
                padding: 8px;
                order: 1;
            }
            
            .preview-and-tools {
                flex-direction: column;
            }
            
            .preview-section {
                margin-bottom: 10px;
            }
            
            .tools-section {
                max-height: none;
            }
            
            .id-photo-tools {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .filter-options {
                grid-template-columns: 1fr;
            }
            
            .filter-options.advanced {
                grid-template-columns: 1fr;
            }
            
            .id-photo-option {
                padding: 8px;
            }
            
            .id-photo-preview {
                height: 70px;
            }
            
            .tool-section {
                padding: 10px;
                margin-bottom: 8px;
            }
            
            .tool-section h2 {
                font-size: 1rem;
                margin-bottom: 8px;
            }
            
            .tool-group h3 {
                font-size: 0.85rem;
                margin-bottom: 4px;
            }
            
            .btn {
                padding: 5px 6px;
                font-size: 0.7rem;
                gap: 3px;
            }
            
            .action-btn {
                padding: 6px;
                font-size: 0.75rem;
            }
            
            .format-btn {
                padding: 5px;
                font-size: 0.75rem;
            }
            
            .slider-container {
                margin: 6px 0;
            }
            
            .slider-container label {
                font-size: 0.75rem;
                margin-bottom: 3px;
            }
            
            .upload-area {
                padding: 15px 10px;
                margin-bottom: 10px;
            }
            
            .upload-area i {
                font-size: 32px;
                margin-bottom: 8px;
            }
            
            .upload-area h3 {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }
            
            .upload-area p {
                font-size: 0.8rem;
            }
            
            .preview-container {
                padding: 8px;
                margin-bottom: 8px;
            }
            
            .placeholder-image {
                font-size: 0.85rem;
            }
            
            .placeholder-image i {
                font-size: 2rem;
                margin-bottom: 8px;
            }
            
            .id-photo-desc {
                font-size: 0.65rem;
            }
            
            .id-photo-usage {
                font-size: 0.6rem;
            }
            
            .bg-color-picker {
                gap: 6px;
            }
            
            .bg-color-option {
                width: 18px;
                height: 18px;
            }
            
            footer {
                padding: 8px;
                font-size: 0.7rem;
            }
        }
        
        /* 超小屏幕 */
        @media (max-width: 400px) {
            header {
                padding: 10px 12px;
            }
            
            header h1 {
                font-size: 1.2rem;
            }
            
            .logo i {
                font-size: 1.3rem;
            }
            
            .language-btn {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
            
            .sidebar {
                padding: 8px;
            }
            
            .editor-area {
                padding: 6px;
            }
            
            .tool-section {
                padding: 8px;
            }
            
            .btn {
                padding: 4px 5px;
                font-size: 0.65rem;
            }
            
            .action-btn {
                padding: 5px;
                font-size: 0.7rem;
            }
            
            .upload-area {
                padding: 12px 8px;
            }
            
            .upload-area i {
                font-size: 28px;
            }
        }
        
        /* 横屏手机优化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .sidebar {
                max-height: 200px;
            }
            
            .tools-section {
                max-height: 200px;
            }
            
            .preview-container {
                min-height: 200px;
            }
        }
        
        /* 移动端菜单样式 */
        .mobile-menu-btn {
            display: none;
        }
        
        .mobile-sidebar {
            display: none;
            position: fixed;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100vh;
            background: white;
            z-index: 999;
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        
        .mobile-sidebar.show {
            left: 0;
        }
        
        .mobile-sidebar-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-sidebar-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .mobile-sidebar-content {
            padding: 20px;
        }
        
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        
        .mobile-overlay.show {
            display: block;
        }
        
        /* 移动端菜单按钮显示 */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .help-btn-text {
                display: none;
            }
            
            .language-btn span {
                display: none;
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) and (pointer: coarse) {
            .btn, .action-btn, .format-btn, .filter-option, .id-photo-option {
                min-height: 44px;
                min-width: 44px;
            }
            
            .slider {
                height: 8px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 20px;
                height: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-image"></i>
                <div>
                    <h1 data-i18n="app_title">图片在线编辑器</h1>
                    <p data-i18n="app_subtitle">专业图片编辑与证件照制作工具</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="language-selector">
                    <button class="language-btn" id="languageBtn">
                        <span id="currentLanguage">中文</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="language-dropdown" id="languageDropdown">
                        <div class="language-option active" data-lang="zh" onclick="changeLanguage('zh')">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMCAyMCI+PHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZGUyOTI2Ii8+PHBhdGggZD0iTTAgMGgxMHYyMEgweiIgZmlsbD0iIzAwNzUwZCIvPjxjaXJjbGUgY3g9IjUiIGN5PSIxMCIgcj0iMyIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0xMCA2aDEwdjJIMTB6bTAgNGgxMHYySDEwem0wIDRoMTB2MkgxMHoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=" class="flag" alt="中文">
                            <span>中文</span>
                        </div>
                        <div class="language-option" data-lang="en" onclick="changeLanguage('en')">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMCAyMCI+PHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjMDAyNDdkIi8+PHBhdGggZD0iTTAgMGgxMHYyMEgweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0wIDBoMzB2NEgweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0wIDhoMzB2NEgweiIgZmlsbD0iI2ZmZiIvPjxwYXRoIGQ9Ik0wIDE2aDMwdjRIMHoiIGZpbGw9IiNmZmYiLz48cGF0aCBkPSJNMTAgMGg0djIwSDIwdjRIMTB6IiBmaWxsPSIjZmZmIi8+PC9zdmc+" class="flag" alt="English">
                            <span>English</span>
                        </div>
                        <div class="language-option" data-lang="ja" onclick="changeLanguage('ja')">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMCAyMCI+PHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iMTUiIGN5PSIxMCIgcj0iNiIgZmlsbD0iI2JjMDAyZCIvPjwvc3ZnPg==" class="flag" alt="日本語">
                            <span>日本語</span>
                        </div>
                        <div class="language-option" data-lang="vi" onclick="changeLanguage('vi')">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMCAyMCI+PHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZGEyNTE1Ii8+PGNpcmNsZSBjeD0iMTUiIGN5PSIxMCIgcj0iNiIgZmlsbD0iI2ZmZiIvPjwvc3ZnPg==" class="flag" alt="Tiếng Việt">
                            <span>Tiếng Việt</span>
                        </div>
                        <div class="language-option" data-lang="fr" onclick="changeLanguage('fr')">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMCAyMCI+PHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZmZmIi8+PHJlY3Qgd2lkdGg9IjEwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjMDAyNjVGIi8+PHJlY3QgeD0iMjAiIHdpZHRoPSIxMCIgaGVpZ2h0PSIyMCIgZmlsbD0iI0VEMDEyMyIvPjwvc3ZnPg==" class="flag" alt="Français">
                            <span>Français</span>
                        </div>
                        <div class="language-option" data-lang="ko" onclick="changeLanguage('ko')">
                            <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzMCAyMCI+PHJlY3Qgd2lkdGg9IjMwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZmZmIi8+PGNpcmNsZSBjeD0iMTUiIGN5PSIxMCIgcj0iNiIgZmlsbD0iIzM0NTFBMSIvPjxwYXRoIGQ9Ik0xMiA2aDZ2OEgxMnoiIGZpbGw9IiNENTM3NDciLz48L3N2Zz4=" class="flag" alt="한국어">
                            <span>한국어</span>
                        </div>
                    </div>
                </div>
                <button class="btn" id="helpBtn"><i class="fas fa-question-circle"></i> <span data-i18n="help_btn">使用帮助</span></button>
                <button class="btn mobile-menu-btn" id="mobileMenuBtn" style="display: none;"><i class="fas fa-bars"></i></button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3 data-i18n="upload_title">点击或拖拽上传图片</h3>
                    <p data-i18n="upload_subtitle">支持 JPG, PNG, GIF, WEBP 格式</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
                
                <div class="tool-section">
                    <h2><i class="fas fa-crop-alt"></i> <span data-i18n="crop_title">裁剪与调整</span></h2>
                    
                    <div class="tool-group">
                        <h3><i class="fas fa-expand-arrows-alt"></i> <span data-i18n="size_adjustment">尺寸调整</span></h3>
                        <div class="tool-options">
                            <button class="btn" id="cropSquareBtn"><i class="fas fa-square"></i> <span data-i18n="square_crop">正方形</span></button>
                            <button class="btn" id="cropCustomBtn"><i class="fas fa-crop"></i> <span data-i18n="custom_crop">自定义</span></button>
                            <button class="btn" id="cropResetBtn"><i class="fas fa-undo"></i> <span data-i18n="reset_crop">重置裁剪</span></button>
                        </div>
                        
                        <!-- 自定义像素裁剪 -->
                        <div class="custom-crop-panel" id="customCropPanel" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <h4 style="margin: 0 0 15px 0; font-size: 0.9rem; color: #495057;"><i class="fas fa-ruler"></i> 精确像素裁剪</h4>
                            <div class="crop-inputs" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                <div class="input-group">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.8rem; color: #6c757d;">X坐标 (像素)</label>
                                    <input type="number" id="cropX" class="crop-input" placeholder="0" min="0" max="9999" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div class="input-group">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.8rem; color: #6c757d;">Y坐标 (像素)</label>
                                    <input type="number" id="cropY" class="crop-input" placeholder="0" min="0" max="9999" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div class="input-group">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.8rem; color: #6c757d;">宽度 (像素)</label>
                                    <input type="number" id="cropWidth" class="crop-input" placeholder="100" min="1" max="9999" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                                <div class="input-group">
                                    <label style="display: block; margin-bottom: 5px; font-size: 0.8rem; color: #6c757d;">高度 (像素)</label>
                                    <input type="number" id="cropHeight" class="crop-input" placeholder="100" min="1" max="9999" style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem;">
                                </div>
                            </div>
                            <div class="quick-crop" style="margin-bottom: 15px;">
                                <h5 style="margin: 0 0 8px 0; font-size: 0.8rem; color: #6c757d;">快速设置</h5>
                                <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                    <button class="btn" id="cropCenterBtn" style="padding: 4px 8px; font-size: 0.8rem; background: #6c757d; color: white;">居中裁剪</button>
                                    <button class="btn" id="cropFullBtn" style="padding: 4px 8px; font-size: 0.8rem; background: #6c757d; color: white;">全图裁剪</button>
                                    <button class="btn" id="cropSquareBtn" style="padding: 4px 8px; font-size: 0.8rem; background: #6c757d; color: white;">正方形</button>
                                </div>
                            </div>
                            <div class="crop-actions" style="display: flex; gap: 10px;">
                                <button class="btn" id="previewCropBtn" style="flex: 1; padding: 8px 12px; font-size: 0.9rem;"><i class="fas fa-eye"></i> 预览裁剪</button>
                                <button class="btn" id="applyCropBtn" style="flex: 1; padding: 8px 12px; font-size: 0.9rem; background: #28a745;"><i class="fas fa-check"></i> 应用裁剪</button>
                            </div>
                            <div class="crop-info" style="margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; font-size: 0.8rem; color: #6c757d;">
                                <div>当前图片尺寸: <span id="currentImageSize">--</span></div>
                                <div>裁剪区域: <span id="cropAreaInfo">--</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tool-group">
                        <h3><i class="fas fa-sync"></i> <span data-i18n="rotate_flip">旋转与翻转</span></h3>
                        <div class="tool-options">
                            <button class="btn" id="rotateLeftBtn"><i class="fas fa-undo"></i> <span data-i18n="rotate_left">左旋转</span></button>
                            <button class="btn" id="rotateRightBtn"><i class="fas fa-redo"></i> <span data-i18n="rotate_right">右旋转</span></button>
                            <button class="btn" id="flipHorizontalBtn"><i class="fas fa-arrows-alt-h"></i> <span data-i18n="flip_horizontal">水平翻转</span></button>
                            <button class="btn" id="flipVerticalBtn"><i class="fas fa-arrows-alt-v"></i> <span data-i18n="flip_vertical">垂直翻转</span></button>
                        </div>
                    </div>
                </div>
                
                
                
                <div class="tool-section">
                    <h2><i class="fas fa-history"></i> <span data-i18n="history_tools">历史记录</span></h2>
                    
                    <div class="tool-group">
                        <div class="tool-options">
                            <button class="btn" id="undoBtn" disabled><i class="fas fa-undo"></i> <span data-i18n="undo">撤销</span></button>
                            <button class="btn" id="redoBtn" disabled><i class="fas fa-redo"></i> <span data-i18n="redo">重做</span></button>
                            <button class="btn" id="clearHistoryBtn"><i class="fas fa-trash"></i> <span data-i18n="clear_history">清空历史</span></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="editor-area">
                <div class="preview-and-tools">
                    <div class="preview-section">
                        <div class="preview-container">
                            <div class="placeholder-image" id="placeholder">
                                <i class="fas fa-image"></i>
                                <span data-i18n="preview_area">图片预览区域</span>
                            </div>
                            <img id="imagePreview" alt="预览图片">
                        </div>
                        
                        <div class="tool-section">
                            <h2><i class="fas fa-file-export"></i> <span data-i18n="export_download">导出与下载</span></h2>
                            
                            <div class="format-options">
                                <div class="format-btn active" data-format="jpeg">JPG</div>
                                <div class="format-btn" data-format="png">PNG</div>
                                <div class="format-btn" data-format="webp">WEBP</div>
                            </div>
                            
                            <div class="action-buttons">
                                <button class="action-btn reset-btn" id="resetBtn">
                                    <i class="fas fa-undo"></i> <span data-i18n="reset_image">重置图片</span>
                                </button>
                                <button class="action-btn download-btn" id="downloadBtn">
                                    <i class="fas fa-download"></i> <span data-i18n="download_image">下载图片</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tools-section">
                        <div class="tool-section">
                            <h2><i class="fas fa-id-card"></i> <span data-i18n="id_photo_tools">证件照工具</span></h2>
                            <p style="margin-bottom: 12px; color: #666; font-weight: 500; font-size: 0.9rem;" data-i18n="id_photo_description">
                                选择常用证件照尺寸，快速裁剪制作
                            </p>
                            
                            <div class="id-photo-tools">
                                <div class="id-photo-option active" data-size="1inch" data-ratio="0.714">
                                    <div class="id-photo-preview">
                                        <div style="width: 50px; height: 70px; background: #4b6cb7; border-radius: 3px;"></div>
                                    </div>
                                    <div class="id-photo-size" data-i18n="1inch_photo">1寸证件照</div>
                                    <div class="id-photo-desc">25mm × 35mm (2.5×3.5cm)</div>
                                    <div class="id-photo-usage" data-i18n="1inch_usage">常用于简历、报名表</div>
                                </div>
                                
                                <div class="id-photo-option" data-size="2inch" data-ratio="0.714">
                                    <div class="id-photo-preview">
                                        <div style="width: 60px; height: 85px; background: #4b6cb7; border-radius: 3px;"></div>
                                    </div>
                                    <div class="id-photo-size" data-i18n="2inch_photo">2寸证件照</div>
                                    <div class="id-photo-desc">35mm × 49mm (3.5×4.9cm)</div>
                                    <div class="id-photo-usage" data-i18n="2inch_usage">常用于护照、签证</div>
                                </div>
                                
                                <div class="id-photo-option" data-size="small2inch" data-ratio="0.6875">
                                    <div class="id-photo-preview">
                                        <div style="width: 55px; height: 80px; background: #4b6cb7; border-radius: 3px;"></div>
                                    </div>
                                    <div class="id-photo-size" data-i18n="small2inch_photo">小2寸证件照</div>
                                    <div class="id-photo-desc">33mm × 48mm (3.3×4.8cm)</div>
                                    <div class="id-photo-usage" data-i18n="small2inch_usage">常用于毕业证、简历</div>
                                </div>
                                
                                <div class="id-photo-option" data-size="large1inch" data-ratio="0.727">
                                    <div class="id-photo-preview">
                                        <div style="width: 60px; height: 85px; background: #4b6cb7; border-radius: 3px;"></div>
                                    </div>
                                    <div class="id-photo-size" data-i18n="large1inch_photo">大1寸证件照</div>
                                    <div class="id-photo-desc">40mm × 55mm (4.0×5.5cm)</div>
                                    <div class="id-photo-usage" data-i18n="large1inch_usage">常用于职称考试</div>
                                </div>
                            </div>
                            
                            
                            <div class="id-photo-controls">
                                <button class="btn" id="applyCropBtn"><i class="fas fa-crop"></i> <span data-i18n="apply_crop">应用裁剪</span></button>
                                <button class="btn" id="downloadIdPhotoBtn"><i class="fas fa-download"></i> <span data-i18n="download_id_photo">下载证件照</span></button>
                            </div>
                        </div>
                        
                        <div class="tool-section">
                            <h2><i class="fas fa-compress-alt"></i> <span data-i18n="compression_tools">压缩工具</span></h2>
                            
                            <div class="tool-group">
                                <div class="slider-container">
                                    <label><span data-i18n="image_quality">图片质量</span> <span class="slider-value" id="compressionQualityValue">85%</span></label>
                                    <input type="range" id="compressionQualitySlider" class="slider" min="10" max="100" value="85">
                                </div>
                                <div class="slider-container">
                                    <label><span data-i18n="image_width">图片宽度</span> <span class="slider-value" id="widthValue">原始</span></label>
                                    <input type="range" id="widthSlider" class="slider" min="100" max="2000" value="1000">
                                </div>
                                <div class="slider-container">
                                    <label><span data-i18n="image_height">图片高度</span> <span class="slider-value" id="heightValue">原始</span></label>
                                    <input type="range" id="heightSlider" class="slider" min="100" max="2000" value="1000">
                                </div>
                                
                                <!-- 预计文件大小显示 -->
                                <div class="file-size-preview" style="margin-top: 15px; padding: 12px; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                    <h4 style="margin: 0 0 8px 0; font-size: 0.9rem; color: #495057;" data-i18n="estimated_size">预计文件大小</h4>
                                    <div class="size-info">
                                        <div class="size-item">
                                            <span class="size-label" data-i18n="original_size">原始大小:</span>
                                            <span class="size-value" id="originalSize">--</span>
                                        </div>
                                        <div class="size-item">
                                            <span class="size-label" data-i18n="compressed_size">压缩后:</span>
                                            <span class="size-value" id="compressedSize">--</span>
                                        </div>
                                        <div class="size-item">
                                            <span class="size-label" data-i18n="compression_ratio">压缩比:</span>
                                            <span class="size-value" id="compressionRatio">--</span>
                                        </div>
                                    </div>
                                    <div class="size-bar" style="margin-top: 10px;">
                                        <div class="size-bar-bg" style="width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                                            <div class="size-bar-fill" id="sizeBarFill" style="height: 100%; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); width: 0%; transition: width 0.3s ease;"></div>
                                        </div>
                                        <div class="size-bar-labels" style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.75rem; color: #6c757d;">
                                            <span>小</span>
                                            <span>中</span>
                                            <span>大</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tool-options" style="margin-top: 15px;">
                                    <button class="btn" id="applyCompressionBtn"><i class="fas fa-compress"></i> <span data-i18n="apply_compression">应用压缩</span></button>
                                    <button class="btn" id="resetCompressionBtn"><i class="fas fa-undo"></i> <span data-i18n="reset_compression">重置压缩</span></button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tool-section">
                            <h2><i class="fas fa-palette"></i> <span data-i18n="advanced_filters">高级滤镜</span></h2>
                            
                            <div class="filter-options advanced">
                                <div class="filter-option" data-filter="vintage">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #8B4513, #D2691E);"></div>
                                    <span data-i18n="vintage">复古</span>
                                </div>
                                <div class="filter-option" data-filter="blackWhite">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #000, #fff);"></div>
                                    <span data-i18n="black_white">黑白</span>
                                </div>
                                <div class="filter-option" data-filter="sepia">
                                    <div class="filter-preview" style="background: #8B4513;"></div>
                                    <span data-i18n="sepia">棕褐色</span>
                                </div>
                                <div class="filter-option" data-filter="cool">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #00BFFF, #4169E1);"></div>
                                    <span data-i18n="cool">冷色调</span>
                                </div>
                                <div class="filter-option" data-filter="warm">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #FF6347, #FFD700);"></div>
                                    <span data-i18n="warm">暖色调</span>
                                </div>
                                <div class="filter-option" data-filter="dramatic">
                                    <div class="filter-preview" style="background: linear-gradient(45deg, #2F4F4F, #000);"></div>
                                    <span data-i18n="dramatic">戏剧性</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="tool-section">
                            <h2><i class="fas fa-crop-alt"></i> <span data-i18n="ai_tools">AI工具</span></h2>
                            
                            <div class="tool-group">
                                <div class="tool-options">
                                    <button class="btn" id="removeBgBtn"><i class="fas fa-user-slash"></i> <span data-i18n="remove_background">智能去背景</span></button>
                                    <button class="btn" id="enhanceBtn"><i class="fas fa-star"></i> <span data-i18n="enhance_image">智能增强</span></button>
                                </div>
                                <div class="tool-options">
                                    <button class="btn" id="faceDetectBtn"><i class="fas fa-eye"></i> <span data-i18n="face_detection">人脸检测</span></button>
                                    <button class="btn" id="autoCropBtn"><i class="fas fa-crop"></i> <span data-i18n="auto_crop">智能裁剪</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>© 2023 <span data-i18n="app_title">图片在线编辑器</span> | <span data-i18n="footer_text">专业证件照制作工具</span></p>
        </footer>
    </div>

    <!-- 移动端侧边栏 -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
    <div class="mobile-sidebar" id="mobileSidebar">
        <div class="mobile-sidebar-header">
            <h3 data-i18n="app_title">图片在线编辑器</h3>
            <button class="mobile-sidebar-close" id="mobileSidebarClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="mobile-sidebar-content">
            <!-- 移动端侧边栏内容将在这里动态生成 -->
        </div>
    </div>

    <div class="notification" id="notification">
        <span data-i18n="download_success">图片已成功下载！</span>
    </div>


    <script>
        // 多语言支持
        const translations = {
            zh: {
                app_title: "图片在线编辑器",
                app_subtitle: "专业图片编辑与证件照制作工具",
                help_btn: "使用帮助",
                upload_title: "点击或拖拽上传图片",
                upload_subtitle: "支持 JPG, PNG, GIF, WEBP 格式",
                crop_title: "裁剪与调整",
                size_adjustment: "尺寸调整",
                square_crop: "正方形",
                custom_crop: "自定义",
                reset_crop: "重置裁剪",
                rotate_flip: "旋转与翻转",
                rotate_left: "左旋转",
                rotate_right: "右旋转",
                flip_horizontal: "水平翻转",
                flip_vertical: "垂直翻转",
                image_adjustment: "图像调整",
                brightness: "亮度",
                contrast: "对比度",
                saturation: "饱和度",
                preview_area: "图片预览区域",
                export_download: "导出与下载",
                reset_image: "重置图片",
                download_image: "下载图片",
                id_photo_tools: "证件照工具",
                id_photo_description: "选择常用证件照尺寸，快速裁剪制作",
                "1inch_photo": "1寸证件照",
                "1inch_usage": "常用于简历、报名表",
                "2inch_photo": "2寸证件照",
                "2inch_usage": "常用于护照、签证",
                "small2inch_photo": "小2寸证件照",
                "small2inch_usage": "常用于毕业证、简历",
                "large1inch_photo": "大1寸证件照",
                "large1inch_usage": "常用于职称考试",
                background_color: "背景颜色",
                apply_crop: "应用裁剪",
                download_id_photo: "下载证件照",
                photo_background: "照片背景",
                original: "原图",
                standard_blue: "标准蓝",
                standard_red: "标准红",
                pure_white: "纯白",
                neutral_gray: "中性灰",
                light_blue: "浅蓝",
                footer_text: "专业证件照制作工具",
                download_success: "图片已成功下载！",
                upload_success: "图片上传成功",
                no_image_error: "请先上传图片",
                help_message: "使用帮助：1.上传图片 2.选择证件照尺寸 3.应用裁剪 4.下载保存",
                square_crop_set: "已设置为正方形裁剪比例",
                free_crop_set: "已设置为自由裁剪模式",
                crop_reset: "裁剪已重置",
                rotate_left_done: "图片向左旋转90度",
                rotate_right_done: "图片向右旋转90度",
                flip_horizontal_done: "图片已水平翻转",
                flip_vertical_done: "图片已垂直翻转",
                image_reset: "图片已重置",
                no_image_reset: "没有可重置的图片",
                crop_applied: "已应用裁剪",
                id_photo_downloaded: "证件照已成功下载！",
                hue: "色相",
                blur: "模糊",
                compression_tools: "压缩工具",
                quality_settings: "质量设置",
                image_quality: "图片质量",
                compress_image: "压缩图片",
                auto_optimize: "智能优化",
                history_tools: "历史记录",
                undo: "撤销",
                redo: "重做",
                clear_history: "清空历史",
                advanced_filters: "高级滤镜",
                vintage: "复古",
                black_white: "黑白",
                sepia: "棕褐色",
                cool: "冷色调",
                warm: "暖色调",
                dramatic: "戏剧性",
                ai_tools: "AI工具",
                remove_background: "智能去背景",
                enhance_image: "智能增强",
                face_detection: "人脸检测",
                auto_crop: "智能裁剪",
                image_compressed: "图片已压缩",
                image_optimized: "图片已智能优化",
                undo_success: "已撤销",
                redo_success: "已重做",
                history_cleared: "历史记录已清空",
                ai_feature_coming: "AI功能即将推出，敬请期待！",
                image_width: "图片宽度",
                image_height: "图片高度",
                estimated_size: "预计文件大小",
                original_size: "原始大小",
                compressed_size: "压缩后",
                compression_ratio: "压缩比",
            apply_compression: "应用压缩",
            reset_compression: "重置压缩",
            apply_adjustments: "应用调整"
            },
            en: {
                app_title: "Online Image Editor",
                app_subtitle: "Professional Image Editing & ID Photo Tool",
                help_btn: "Help",
                upload_title: "Click or Drag to Upload Image",
                upload_subtitle: "Supports JPG, PNG, GIF, WEBP formats",
                crop_title: "Crop & Adjust",
                size_adjustment: "Size Adjustment",
                square_crop: "Square",
                custom_crop: "Custom",
                reset_crop: "Reset Crop",
                rotate_flip: "Rotate & Flip",
                rotate_left: "Rotate Left",
                rotate_right: "Rotate Right",
                flip_horizontal: "Flip Horizontal",
                flip_vertical: "Flip Vertical",
                image_adjustment: "Image Adjustment",
                brightness: "Brightness",
                contrast: "Contrast",
                saturation: "Saturation",
                preview_area: "Image Preview Area",
                export_download: "Export & Download",
                reset_image: "Reset Image",
                download_image: "Download Image",
                id_photo_tools: "ID Photo Tools",
                id_photo_description: "Select common ID photo sizes for quick cropping",
                "1inch_photo": "1-inch ID Photo",
                "1inch_usage": "Commonly used for resumes, applications",
                "2inch_photo": "2-inch ID Photo",
                "2inch_usage": "Commonly used for passports, visas",
                "small2inch_photo": "Small 2-inch ID Photo",
                "small2inch_usage": "Commonly used for diplomas, resumes",
                "large1inch_photo": "Large 1-inch ID Photo",
                "large1inch_usage": "Commonly used for professional exams",
                background_color: "Background Color",
                apply_crop: "Apply Crop",
                download_id_photo: "Download ID Photo",
                photo_background: "Photo Background",
                original: "Original",
                standard_blue: "Standard Blue",
                standard_red: "Standard Red",
                pure_white: "Pure White",
                neutral_gray: "Neutral Gray",
                light_blue: "Light Blue",
                footer_text: "Professional ID Photo Tool",
                download_success: "Image downloaded successfully!",
                upload_success: "Image uploaded successfully",
                no_image_error: "Please upload an image first",
                help_message: "Usage: 1. Upload image 2. Select ID photo size 3. Apply crop 4. Download",
                square_crop_set: "Square crop ratio set",
                free_crop_set: "Free crop mode set",
                crop_reset: "Crop reset",
                rotate_left_done: "Image rotated 90° left",
                rotate_right_done: "Image rotated 90° right",
                flip_horizontal_done: "Image flipped horizontally",
                flip_vertical_done: "Image flipped vertically",
                image_reset: "Image reset",
                no_image_reset: "No image to reset",
                crop_applied: "Crop applied",
                id_photo_downloaded: "ID photo downloaded successfully!",
                image_width: "Image Width",
                image_height: "Image Height",
                estimated_size: "Estimated File Size",
                original_size: "Original Size",
                compressed_size: "Compressed",
                compression_ratio: "Compression Ratio",
                apply_compression: "Apply Compression",
                reset_compression: "Reset Compression",
                apply_adjustments: "Apply Adjustments"
            },
            ja: {
                app_title: "オンライン画像エディター",
                app_subtitle: "プロフェッショナルな画像編集と証明写真作成ツール",
                help_btn: "ヘルプ",
                upload_title: "クリックまたはドラッグで画像をアップロード",
                upload_subtitle: "JPG、PNG、GIF、WEBP形式をサポート",
                crop_title: "切り抜きと調整",
                size_adjustment: "サイズ調整",
                square_crop: "正方形",
                custom_crop: "カスタム",
                reset_crop: "切り抜きリセット",
                rotate_flip: "回転と反転",
                rotate_left: "左回転",
                rotate_right: "右回転",
                flip_horizontal: "水平反転",
                flip_vertical: "垂直反転",
                image_adjustment: "画像調整",
                brightness: "明るさ",
                contrast: "コントラスト",
                saturation: "彩度",
                preview_area: "画像プレビューエリア",
                export_download: "エクスポートとダウンロード",
                reset_image: "画像リセット",
                download_image: "画像ダウンロード",
                id_photo_tools: "証明写真ツール",
                id_photo_description: "一般的な証明写真サイズを選択して素早く切り抜き",
                "1inch_photo": "1インチ証明写真",
                "1inch_usage": "履歴書、申込書に使用",
                "2inch_photo": "2インチ証明写真",
                "2inch_usage": "パスポート、ビザに使用",
                "small2inch_photo": "小2インチ証明写真",
                "small2inch_usage": "卒業証書、履歴書に使用",
                "large1inch_photo": "大1インチ証明写真",
                "large1inch_usage": "資格試験に使用",
                background_color: "背景色",
                apply_crop: "切り抜き適用",
                download_id_photo: "証明写真ダウンロード",
                photo_background: "写真背景",
                original: "元の画像",
                standard_blue: "標準ブルー",
                standard_red: "標準レッド",
                pure_white: "純白",
                neutral_gray: "ニュートラルグレー",
                light_blue: "ライトブルー",
                footer_text: "プロフェッショナル証明写真ツール",
                download_success: "画像をダウンロードしました！",
                upload_success: "画像をアップロードしました",
                no_image_error: "まず画像をアップロードしてください",
                help_message: "使用方法：1.画像をアップロード 2.証明写真サイズを選択 3.切り抜きを適用 4.ダウンロード",
                square_crop_set: "正方形の切り抜き比率を設定しました",
                free_crop_set: "自由切り抜きモードを設定しました",
                crop_reset: "切り抜きをリセットしました",
                rotate_left_done: "画像を左に90度回転しました",
                rotate_right_done: "画像を右に90度回転しました",
                flip_horizontal_done: "画像を水平反転しました",
                flip_vertical_done: "画像を垂直反転しました",
                image_reset: "画像をリセットしました",
                no_image_reset: "リセットする画像がありません",
                crop_applied: "切り抜きを適用しました",
                id_photo_downloaded: "証明写真をダウンロードしました！"
            },
            vi: {
                app_title: "Trình chỉnh sửa ảnh trực tuyến",
                app_subtitle: "Công cụ chỉnh sửa ảnh chuyên nghiệp & ảnh thẻ",
                help_btn: "Trợ giúp",
                upload_title: "Nhấp hoặc kéo để tải ảnh lên",
                upload_subtitle: "Hỗ trợ định dạng JPG, PNG, GIF, WEBP",
                crop_title: "Cắt & Điều chỉnh",
                size_adjustment: "Điều chỉnh kích thước",
                square_crop: "Vuông",
                custom_crop: "Tùy chỉnh",
                reset_crop: "Đặt lại cắt",
                rotate_flip: "Xoay & Lật",
                rotate_left: "Xoay trái",
                rotate_right: "Xoay phải",
                flip_horizontal: "Lật ngang",
                flip_vertical: "Lật dọc",
                image_adjustment: "Điều chỉnh ảnh",
                brightness: "Độ sáng",
                contrast: "Độ tương phản",
                saturation: "Độ bão hòa",
                preview_area: "Khu vực xem trước ảnh",
                export_download: "Xuất & Tải xuống",
                reset_image: "Đặt lại ảnh",
                download_image: "Tải ảnh xuống",
                id_photo_tools: "Công cụ ảnh thẻ",
                id_photo_description: "Chọn kích thước ảnh thẻ phổ biến để cắt nhanh",
                "1inch_photo": "Ảnh thẻ 1 inch",
                "1inch_usage": "Thường dùng cho hồ sơ, đơn xin việc",
                "2inch_photo": "Ảnh thẻ 2 inch",
                "2inch_usage": "Thường dùng cho hộ chiếu, visa",
                "small2inch_photo": "Ảnh thẻ 2 inch nhỏ",
                "small2inch_usage": "Thường dùng cho bằng tốt nghiệp, hồ sơ",
                "large1inch_photo": "Ảnh thẻ 1 inch lớn",
                "large1inch_usage": "Thường dùng cho kỳ thi chuyên môn",
                background_color: "Màu nền",
                apply_crop: "Áp dụng cắt",
                download_id_photo: "Tải ảnh thẻ xuống",
                photo_background: "Nền ảnh",
                original: "Ảnh gốc",
                standard_blue: "Xanh chuẩn",
                standard_red: "Đỏ chuẩn",
                pure_white: "Trắng tinh",
                neutral_gray: "Xám trung tính",
                light_blue: "Xanh nhạt",
                footer_text: "Công cụ ảnh thẻ chuyên nghiệp",
                download_success: "Đã tải ảnh xuống thành công!",
                upload_success: "Đã tải ảnh lên thành công",
                no_image_error: "Vui lòng tải ảnh lên trước",
                help_message: "Hướng dẫn: 1. Tải ảnh lên 2. Chọn kích thước ảnh thẻ 3. Áp dụng cắt 4. Tải xuống",
                square_crop_set: "Đã đặt tỷ lệ cắt vuông",
                free_crop_set: "Đã đặt chế độ cắt tự do",
                crop_reset: "Đã đặt lại cắt",
                rotate_left_done: "Đã xoay ảnh 90° sang trái",
                rotate_right_done: "Đã xoay ảnh 90° sang phải",
                flip_horizontal_done: "Đã lật ảnh ngang",
                flip_vertical_done: "Đã lật ảnh dọc",
                image_reset: "Đã đặt lại ảnh",
                no_image_reset: "Không có ảnh để đặt lại",
                crop_applied: "Đã áp dụng cắt",
                id_photo_downloaded: "Đã tải ảnh thẻ xuống thành công!"
            },
            fr: {
                app_title: "Éditeur d'image en ligne",
                app_subtitle: "Outil professionnel d'édition d'image et de photo d'identité",
                help_btn: "Aide",
                upload_title: "Cliquez ou glissez pour télécharger une image",
                upload_subtitle: "Supporte les formats JPG, PNG, GIF, WEBP",
                crop_title: "Rogner & Ajuster",
                size_adjustment: "Ajustement de taille",
                square_crop: "Carré",
                custom_crop: "Personnalisé",
                reset_crop: "Réinitialiser le rognage",
                rotate_flip: "Rotation & Retournement",
                rotate_left: "Rotation gauche",
                rotate_right: "Rotation droite",
                flip_horizontal: "Retournement horizontal",
                flip_vertical: "Retournement vertical",
                image_adjustment: "Ajustement d'image",
                brightness: "Luminosité",
                contrast: "Contraste",
                saturation: "Saturation",
                preview_area: "Zone de prévisualisation",
                export_download: "Exporter & Télécharger",
                reset_image: "Réinitialiser l'image",
                download_image: "Télécharger l'image",
                id_photo_tools: "Outils photo d'identité",
                id_photo_description: "Sélectionnez les tailles de photo d'identité courantes pour un rognage rapide",
                "1inch_photo": "Photo d'identité 1 pouce",
                "1inch_usage": "Utilisé pour CV, formulaires",
                "2inch_photo": "Photo d'identité 2 pouces",
                "2inch_usage": "Utilisé pour passeports, visas",
                "small2inch_photo": "Petite photo d'identité 2 pouces",
                "small2inch_usage": "Utilisé pour diplômes, CV",
                "large1inch_photo": "Grande photo d'identité 1 pouce",
                "large1inch_usage": "Utilisé pour examens professionnels",
                background_color: "Couleur de fond",
                apply_crop: "Appliquer le rognage",
                download_id_photo: "Télécharger photo d'identité",
                photo_background: "Arrière-plan photo",
                original: "Original",
                standard_blue: "Bleu standard",
                standard_red: "Rouge standard",
                pure_white: "Blanc pur",
                neutral_gray: "Gris neutre",
                light_blue: "Bleu clair",
                footer_text: "Outil professionnel de photo d'identité",
                download_success: "Image téléchargée avec succès !",
                upload_success: "Image téléchargée avec succès",
                no_image_error: "Veuillez d'abord télécharger une image",
                help_message: "Utilisation : 1. Télécharger l'image 2. Sélectionner la taille de photo 3. Appliquer le rognage 4. Télécharger",
                square_crop_set: "Ratio de rognage carré défini",
                free_crop_set: "Mode de rognage libre défini",
                crop_reset: "Rognage réinitialisé",
                rotate_left_done: "Image tournée de 90° vers la gauche",
                rotate_right_done: "Image tournée de 90° vers la droite",
                flip_horizontal_done: "Image retournée horizontalement",
                flip_vertical_done: "Image retournée verticalement",
                image_reset: "Image réinitialisée",
                no_image_reset: "Aucune image à réinitialiser",
                crop_applied: "Rognage appliqué",
                id_photo_downloaded: "Photo d'identité téléchargée avec succès !"
            },
            ko: {
                app_title: "온라인 이미지 편집기",
                app_subtitle: "전문 이미지 편집 및 증명사진 도구",
                help_btn: "도움말",
                upload_title: "클릭 또는 드래그하여 이미지 업로드",
                upload_subtitle: "JPG, PNG, GIF, WEBP 형식 지원",
                crop_title: "자르기 및 조정",
                size_adjustment: "크기 조정",
                square_crop: "정사각형",
                custom_crop: "사용자 지정",
                reset_crop: "자르기 초기화",
                rotate_flip: "회전 및 뒤집기",
                rotate_left: "왼쪽으로 회전",
                rotate_right: "오른쪽으로 회전",
                flip_horizontal: "수평 뒤집기",
                flip_vertical: "수직 뒤집기",
                image_adjustment: "이미지 조정",
                brightness: "밝기",
                contrast: "대비",
                saturation: "채도",
                preview_area: "이미지 미리보기 영역",
                export_download: "내보내기 및 다운로드",
                reset_image: "이미지 초기화",
                download_image: "이미지 다운로드",
                id_photo_tools: "증명사진 도구",
                id_photo_description: "일반적인 증명사진 크기를 선택하여 빠르게 자르기",
                "1inch_photo": "1인치 증명사진",
                "1inch_usage": "이력서, 지원서에 사용",
                "2inch_photo": "2인치 증명사진",
                "2inch_usage": "여권, 비자에 사용",
                "small2inch_photo": "소형 2인치 증명사진",
                "small2inch_usage": "졸업장, 이력서에 사용",
                "large1inch_photo": "대형 1인치 증명사진",
                "large1inch_usage": "자격 시험에 사용",
                background_color: "배경색",
                apply_crop: "자르기 적용",
                download_id_photo: "증명사진 다운로드",
                photo_background: "사진 배경",
                original: "원본",
                standard_blue: "표준 블루",
                standard_red: "표준 레드",
                pure_white: "순수 화이트",
                neutral_gray: "중성 그레이",
                light_blue: "라이트 블루",
                footer_text: "전문 증명사진 도구",
                download_success: "이미지를 다운로드했습니다!",
                upload_success: "이미지를 업로드했습니다",
                no_image_error: "먼저 이미지를 업로드해 주세요",
                help_message: "사용법: 1. 이미지 업로드 2. 증명사진 크기 선택 3. 자르기 적용 4. 다운로드",
                square_crop_set: "정사각형 자르기 비율 설정됨",
                free_crop_set: "자유 자르기 모드 설정됨",
                crop_reset: "자르기 초기화됨",
                rotate_left_done: "이미지를 왼쪽으로 90도 회전했습니다",
                rotate_right_done: "이미지를 오른쪽으로 90도 회전했습니다",
                flip_horizontal_done: "이미지를 수평 뒤집기했습니다",
                flip_vertical_done: "이미지를 수직 뒤집기했습니다",
                image_reset: "이미지 초기화됨",
                no_image_reset: "초기화할 이미지가 없습니다",
                crop_applied: "자르기 적용됨",
                id_photo_downloaded: "증명사진을 다운로드했습니다!"
            }
        };

        // 获取DOM元素
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const imagePreview = document.getElementById('imagePreview');
        const placeholder = document.getElementById('placeholder');
        const downloadBtn = document.getElementById('downloadBtn');
        const resetBtn = document.getElementById('resetBtn');
        const helpBtn = document.getElementById('helpBtn');
        const formatOptions = document.querySelectorAll('.format-btn');
        const idPhotoOptions = document.querySelectorAll('.id-photo-option');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const downloadIdPhotoBtn = document.getElementById('downloadIdPhotoBtn');
        const notification = document.getElementById('notification');
        const bgColorOptions = document.querySelectorAll('.bg-color-option');
        const filterOptions = document.querySelectorAll('.filter-option');
        const languageBtn = document.getElementById('languageBtn');
        const languageDropdown = document.getElementById('languageDropdown');
        const currentLanguageSpan = document.getElementById('currentLanguage');
        const languageOptions = document.querySelectorAll('.language-option');
        
        // 移动端菜单元素
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileSidebar = document.getElementById('mobileSidebar');
        const mobileOverlay = document.getElementById('mobileOverlay');
        const mobileSidebarClose = document.getElementById('mobileSidebarClose');
        const mobileSidebarContent = document.querySelector('.mobile-sidebar-content');
        
        // 滑块元素
        const compressionQualitySlider = document.getElementById('compressionQualitySlider');
        const widthSlider = document.getElementById('widthSlider');
        const heightSlider = document.getElementById('heightSlider');
        
        // 滑块值显示
        const compressionQualityValue = document.getElementById('compressionQualityValue');
        const widthValue = document.getElementById('widthValue');
        const heightValue = document.getElementById('heightValue');
        
        // 压缩工具元素
        const originalSize = document.getElementById('originalSize');
        const compressedSize = document.getElementById('compressedSize');
        const compressionRatio = document.getElementById('compressionRatio');
        const sizeBarFill = document.getElementById('sizeBarFill');
        const applyCompressionBtn = document.getElementById('applyCompressionBtn');
        const resetCompressionBtn = document.getElementById('resetCompressionBtn');
        
        // 当前状态
        let selectedFormat = 'jpeg';
        let selectedIdPhotoSize = '1inch';
        let selectedIdPhotoRatio = 0.714;
        let selectedBgColor = '#4b6cb7';
        let selectedFilter = 'none';
        let originalImage = null;
        let currentImage = null;
        let isImageLoaded = false;
        let cropper = null;
        let currentLang = 'zh';
        
        // 历史记录
        let historyStack = [];
        let historyIndex = -1;
        let maxHistorySize = 20;
        
        // 初始化滑块值显示
        compressionQualityValue.textContent = compressionQualitySlider.value + '%';
        
        // 历史记录功能
        function saveToHistory(imageData) {
            // 移除当前位置之后的历史记录
            historyStack = historyStack.slice(0, historyIndex + 1);
            
            // 添加新的历史记录
            historyStack.push(imageData);
            historyIndex++;
            
            // 限制历史记录数量
            if (historyStack.length > maxHistorySize) {
                historyStack.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
        }
        
        // 撤销功能
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                const imageData = historyStack[historyIndex];
                currentImage = imageData;
                imagePreview.src = imageData;
                
                // 重新初始化 cropper
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                updateHistoryButtons();
                showNotification('已撤销', 'success');
            }
        }
        
        // 重做功能
        function redo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                const imageData = historyStack[historyIndex];
                currentImage = imageData;
                imagePreview.src = imageData;
                
                // 重新初始化 cropper
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                updateHistoryButtons();
                showNotification('已重做', 'success');
            }
        }
        
        // 清空历史记录
        function clearHistory() {
            historyStack = [];
            historyIndex = -1;
            updateHistoryButtons();
            showNotification('历史记录已清空', 'success');
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= historyStack.length - 1;
        }
        
        // 语言切换功能 - 简化版本
        function changeLanguage(lang) {
            console.log('Changing language to:', lang);
            currentLang = lang;
            
            // 更新当前语言显示
            const currentOption = document.querySelector(`.language-option[data-lang="${lang}"]`);
            if (currentOption) {
                currentLanguageSpan.textContent = currentOption.textContent.trim();
                
                // 更新语言选项状态
                const allOptions = document.querySelectorAll('.language-option');
                allOptions.forEach(option => {
                    option.classList.remove('active');
                });
                currentOption.classList.add('active');
            }
            
            // 翻译所有文本
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // 隐藏语言下拉菜单
            languageDropdown.classList.remove('show');
            
            // 保存语言偏好
            localStorage.setItem('preferredLanguage', lang);
        }
        
        // 确保changeLanguage函数在全局作用域中可用
        window.changeLanguage = changeLanguage;
        
        // 背景颜色选择函数
        function selectBgColor(color) {
            console.log('Selecting background color:', color);
            selectedBgColor = color;
            
            // 更新所有背景颜色选项的active状态
            const allBgColorOptions = document.querySelectorAll('.bg-color-option');
            allBgColorOptions.forEach(option => {
                option.classList.remove('active');
                if (option.getAttribute('data-color') === color) {
                    option.classList.add('active');
                }
            });
            
            console.log('Background color set to:', selectedBgColor);
        }
        
        // 测试背景颜色函数
        function testBgColor() {
            alert('当前选择的背景颜色: ' + selectedBgColor);
        }
        
        // 确保函数在全局作用域中可用
        window.selectBgColor = selectBgColor;
        window.testBgColor = testBgColor;
        
        // 人像抠图相关变量
        let originalImageData = null;
        let processedImageData = null;
        let isBackgroundRemoved = false;
        
        // 智能抠图功能
        function removeBackground() {
            console.log('removeBackground called');
            console.log('isImageLoaded:', isImageLoaded);
            console.log('imagePreview.src:', imagePreview ? imagePreview.src : 'no imagePreview');
            
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            showNotification('正在处理图片，请稍候...', 'info');
            
            // 创建canvas来处理图片
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 绘制原图
                ctx.drawImage(img, 0, 0);
                
                // 获取图像数据
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // 保存原始图像数据
                originalImageData = new ImageData(
                    new Uint8ClampedArray(data),
                    imageData.width,
                    imageData.height
                );
                
                // 简单的背景移除算法（基于颜色相似性）
                const processedData = removeBackgroundSimple(data, canvas.width, canvas.height);
                
                // 创建处理后的图像数据
                processedImageData = new ImageData(processedData, canvas.width, canvas.height);
                
                // 将处理后的图像显示在预览区域
                ctx.putImageData(processedImageData, 0, 0);
                
                // 更新预览图片
                const newImageData = canvas.toDataURL();
                console.log('New image data length:', newImageData.length);
                
                // 先销毁 cropper 实例
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                imagePreview.src = newImageData;
                currentImage = newImageData;
                isBackgroundRemoved = true;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                showNotification('背景移除完成！', 'success');
            };
            
            img.src = imagePreview.src;
        }
        
        // 高级背景移除算法 - 使用多种技术组合
        function removeBackgroundSimple(data, width, height) {
            const newData = new Uint8ClampedArray(data);
            
            console.log('开始高级抠图处理...');
            
            // 方法1: 边缘采样分析背景色
            const edgeSamples = [];
            const sampleSize = Math.max(5, Math.floor(Math.min(width, height) / 50));
            
            // 从四个边缘采样
            for (let i = 0; i < sampleSize; i++) {
                const x = Math.floor((i / sampleSize) * width);
                const y = Math.floor((i / sampleSize) * height);
                
                // 上边缘
                edgeSamples.push({ x: x, y: 0 });
                // 下边缘
                edgeSamples.push({ x: x, y: height - 1 });
                // 左边缘
                edgeSamples.push({ x: 0, y: y });
                // 右边缘
                edgeSamples.push({ x: width - 1, y: y });
            }
            
            // 计算背景色
            let bgR = 0, bgG = 0, bgB = 0;
            edgeSamples.forEach(point => {
                const index = (point.y * width + point.x) * 4;
                bgR += data[index];
                bgG += data[index + 1];
                bgB += data[index + 2];
            });
            
            bgR = Math.floor(bgR / edgeSamples.length);
            bgG = Math.floor(bgG / edgeSamples.length);
            bgB = Math.floor(bgB / edgeSamples.length);
            
            console.log('检测到背景色:', `rgb(${bgR}, ${bgG}, ${bgB})`);
            
            // 方法2: 使用GrabCut算法的简化版本
            // 创建前景和背景的掩码
            const mask = new Array(width * height).fill(0); // 0=背景, 1=前景, 2=可能前景
            
            // 初始化：边缘为背景，中心为前景
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = y * width + x;
                    const edgeDist = Math.min(x, y, width - x - 1, height - y - 1);
                    
                    if (edgeDist < 10) {
                        mask[index] = 0; // 边缘为背景
                    } else if (edgeDist < 20) {
                        mask[index] = 2; // 可能前景
                    } else {
                        mask[index] = 1; // 中心为前景
                    }
                }
            }
            
            // 迭代优化掩码
            for (let iter = 0; iter < 3; iter++) {
                let changed = false;
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        const index = y * width + x;
                        const pixelIndex = index * 4;
                        
                        if (mask[index] === 2) { // 只处理可能前景的像素
                            const r = data[pixelIndex];
                            const g = data[pixelIndex + 1];
                            const b = data[pixelIndex + 2];
                            
                            // 计算与背景色的距离
                            const bgDistance = Math.sqrt(
                                Math.pow(r - bgR, 2) + 
                                Math.pow(g - bgG, 2) + 
                                Math.pow(b - bgB, 2)
                            );
                            
                            // 计算与周围前景像素的相似性
                            let foregroundSimilarity = 0;
                            let foregroundCount = 0;
                            
                            for (let dy = -1; dy <= 1; dy++) {
                                for (let dx = -1; dx <= 1; dx++) {
                                    const nx = x + dx;
                                    const ny = y + dy;
                                    const nIndex = ny * width + nx;
                                    
                                    if (mask[nIndex] === 1) { // 确定的前景
                                        const nPixelIndex = nIndex * 4;
                                        const nr = data[nPixelIndex];
                                        const ng = data[nPixelIndex + 1];
                                        const nb = data[nPixelIndex + 2];
                                        
                                        const similarity = Math.sqrt(
                                            Math.pow(r - nr, 2) + 
                                            Math.pow(g - ng, 2) + 
                                            Math.pow(b - nb, 2)
                                        );
                                        
                                        foregroundSimilarity += similarity;
                                        foregroundCount++;
                                    }
                                }
                            }
                            
                            if (foregroundCount > 0) {
                                foregroundSimilarity /= foregroundCount;
                            }
                            
                            // 决定像素分类
                            if (bgDistance < 30 && foregroundSimilarity > 50) {
                                mask[index] = 0; // 背景
                                changed = true;
                            } else if (bgDistance > 60 || foregroundSimilarity < 30) {
                                mask[index] = 1; // 前景
                                changed = true;
                            }
                        }
                    }
                }
                
                if (!changed) break;
            }
            
            // 方法3: 边缘检测和形态学操作
            const edgeMap = new Array(width * height).fill(0);
            
            // 简单的边缘检测
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const index = y * width + x;
                    const pixelIndex = index * 4;
                    
                    const r = data[pixelIndex];
                    const g = data[pixelIndex + 1];
                    const b = data[pixelIndex + 2];
                    
                    // 计算梯度
                    let gradient = 0;
                    for (let dy = -1; dy <= 1; dy++) {
                        for (let dx = -1; dx <= 1; dx++) {
                            const nx = x + dx;
                            const ny = y + dy;
                            const nIndex = ny * width + nx;
                            const nPixelIndex = nIndex * 4;
                            
                            const nr = data[nPixelIndex];
                            const ng = data[nPixelIndex + 1];
                            const nb = data[nPixelIndex + 2];
                            
                            const diff = Math.sqrt(
                                Math.pow(r - nr, 2) + 
                                Math.pow(g - ng, 2) + 
                                Math.pow(b - nb, 2)
                            );
                            
                            gradient += diff;
                        }
                    }
                    
                    edgeMap[index] = gradient / 9;
                }
            }
            
            // 应用最终掩码
            for (let i = 0; i < data.length; i += 4) {
                const x = (i / 4) % width;
                const y = Math.floor((i / 4) / width);
                const index = y * width + x;
                
                if (mask[index] === 0) {
                    // 背景 - 设为透明
                    newData[i + 3] = 0;
                } else if (mask[index] === 1) {
                    // 前景 - 保持不透明
                    newData[i + 3] = 255;
                } else {
                    // 可能前景 - 根据边缘强度决定
                    const edgeStrength = edgeMap[index];
                    if (edgeStrength > 20) {
                        // 强边缘 - 保持不透明
                        newData[i + 3] = 255;
                    } else {
                        // 弱边缘 - 渐变透明度
                        const alpha = Math.floor((edgeStrength / 20) * 255);
                        newData[i + 3] = Math.max(0, Math.min(255, alpha));
                    }
                }
            }
            
            console.log('高级抠图处理完成');
            return newData;
        }
        
        // 应用背景颜色
        function applyBackgroundColor() {
            console.log('applyBackgroundColor called');
            console.log('isImageLoaded:', isImageLoaded);
            console.log('isBackgroundRemoved:', isBackgroundRemoved);
            console.log('selectedBgColor:', selectedBgColor);
            
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            if (!isBackgroundRemoved) {
                showNotification('请先进行智能抠图', 'warning');
                return;
            }
            
            if (!selectedBgColor) {
                showNotification('请选择背景颜色', 'warning');
                return;
            }
            
            // 创建canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 先填充背景颜色
                ctx.fillStyle = selectedBgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 再绘制处理后的图片（带透明背景）
                ctx.drawImage(img, 0, 0);
                
                // 更新预览图片
                const newImageData = canvas.toDataURL();
                console.log('Applied background - new image data length:', newImageData.length);
                
                // 先销毁 cropper 实例
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                imagePreview.src = newImageData;
                currentImage = newImageData;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                showNotification('背景颜色已应用！', 'success');
            };
            
            img.src = imagePreview.src;
        }
        
        // 恢复原始图片
        function restoreOriginalImage() {
            if (originalImageData && isBackgroundRemoved) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = originalImageData.width;
                canvas.height = originalImageData.height;
                ctx.putImageData(originalImageData, 0, 0);
                
                imagePreview.src = canvas.toDataURL();
                isBackgroundRemoved = false;
                
                showNotification('已恢复原始图片', 'info');
            }
        }
        
        // 测试函数
        function testRemoveBackground() {
            console.log('testRemoveBackground called');
            alert('测试抠图功能被调用！');
            removeBackground();
        }
        
        // 简单换背景功能（不需要先抠图）
        function simpleBackgroundChange() {
            console.log('simpleBackgroundChange called');
            console.log('selectedBgColor:', selectedBgColor);
            
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            if (!selectedBgColor) {
                showNotification('请先选择背景颜色', 'warning');
                return;
            }
            
            // 创建canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 先填充背景颜色
                ctx.fillStyle = selectedBgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 再绘制原图
                ctx.drawImage(img, 0, 0);
                
                // 更新预览图片
                const newImageData = canvas.toDataURL();
                console.log('Simple background change - new image data length:', newImageData.length);
                
                // 先销毁 cropper 实例
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                imagePreview.src = newImageData;
                currentImage = newImageData;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                showNotification('背景颜色已应用！', 'success');
            };
            
            img.src = imagePreview.src;
        }
        
        // 测试CSS背景功能
        function testBackgroundCSS() {
            console.log('testBackgroundCSS called');
            console.log('selectedBgColor:', selectedBgColor);
            
            if (!selectedBgColor) {
                showNotification('请先选择背景颜色', 'warning');
                return;
            }
            
            // 直接修改图片容器的背景色
            const previewContainer = document.querySelector('.preview-container');
            if (previewContainer) {
                previewContainer.style.backgroundColor = selectedBgColor;
                console.log('Preview container background set to:', selectedBgColor);
                showNotification('CSS背景色已应用！', 'success');
            } else {
                console.log('Preview container not found');
                showNotification('找不到预览容器', 'error');
            }
        }
        
        // 直接换背景功能 - 不需要先抠图
        function directBackgroundReplace() {
            console.log('directBackgroundReplace called');
            console.log('selectedBgColor:', selectedBgColor);
            alert('直接换背景功能被调用！');
            
            if (!isImageLoaded || !imagePreview.src) {
                alert('请先上传图片');
                showNotification('请先上传图片', 'error');
                return;
            }
            
            if (!selectedBgColor) {
                alert('请先选择背景颜色');
                showNotification('请先选择背景颜色', 'warning');
                return;
            }
            
            alert('开始处理图片...');
            
            // 创建canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                console.log('图片加载完成，尺寸:', img.width, 'x', img.height);
                alert('图片加载完成，开始处理...');
                
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 先填充背景颜色
                ctx.fillStyle = selectedBgColor;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                console.log('背景色已填充:', selectedBgColor);
                
                // 再绘制原图
                ctx.drawImage(img, 0, 0);
                console.log('原图已绘制');
                
                // 更新预览图片
                const newImageData = canvas.toDataURL();
                console.log('Direct background replace - new image data length:', newImageData.length);
                alert('新图片数据长度: ' + newImageData.length);
                
                // 先销毁 cropper 实例
                if (cropper) {
                    console.log('销毁 cropper 实例');
                    cropper.destroy();
                    cropper = null;
                }
                
                console.log('更新图片源');
                imagePreview.src = newImageData;
                currentImage = newImageData;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    console.log('重新初始化 cropper');
                    initCropper();
                }, 100);
                
                alert('背景已直接替换！');
                showNotification('背景已直接替换！', 'success');
            };
            
            img.onerror = function() {
                console.error('图片加载失败');
                alert('图片加载失败');
            };
            
            console.log('设置图片源:', imagePreview.src);
            img.src = imagePreview.src;
        }
        
        // 色度键抠图功能 - 更精确的抠图方法
        function chromaKeyRemoval() {
            console.log('chromaKeyRemoval called');
            
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            showNotification('正在进行色度键抠图，请稍候...', 'info');
            
            // 创建canvas来处理图片
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 绘制原图
                ctx.drawImage(img, 0, 0);
                
                // 获取图像数据
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // 保存原始图像数据
                originalImageData = new ImageData(
                    new Uint8ClampedArray(data),
                    imageData.width,
                    imageData.height
                );
                
                // 使用色度键算法处理
                const processedData = chromaKeyProcess(data, canvas.width, canvas.height);
                
                // 创建处理后的图像数据
                processedImageData = new ImageData(processedData, canvas.width, canvas.height);
                
                // 将处理后的图像显示在预览区域
                ctx.putImageData(processedImageData, 0, 0);
                
                // 更新预览图片
                const newImageData = canvas.toDataURL();
                console.log('Chroma key - new image data length:', newImageData.length);
                
                // 先销毁 cropper 实例
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                imagePreview.src = newImageData;
                currentImage = newImageData;
                isBackgroundRemoved = true;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                showNotification('色度键抠图完成！', 'success');
            };
            
            img.src = imagePreview.src;
        }
        
        // 色度键处理算法
        function chromaKeyProcess(data, width, height) {
            const newData = new Uint8ClampedArray(data);
            
            console.log('开始色度键处理...');
            
            // 分析图片边缘来确定背景色
            const edgePixels = [];
            const edgeSize = Math.max(2, Math.floor(Math.min(width, height) / 100));
            
            // 采样边缘像素
            for (let i = 0; i < edgeSize; i++) {
                const x = Math.floor((i / edgeSize) * width);
                const y = Math.floor((i / edgeSize) * height);
                
                // 四个边缘
                edgePixels.push({ x: x, y: 0 });
                edgePixels.push({ x: x, y: height - 1 });
                edgePixels.push({ x: 0, y: y });
                edgePixels.push({ x: width - 1, y: y });
            }
            
            // 计算背景色的平均值
            let bgR = 0, bgG = 0, bgB = 0;
            edgePixels.forEach(pixel => {
                const index = (pixel.y * width + pixel.x) * 4;
                bgR += data[index];
                bgG += data[index + 1];
                bgB += data[index + 2];
            });
            
            bgR = Math.floor(bgR / edgePixels.length);
            bgG = Math.floor(bgG / edgePixels.length);
            bgB = Math.floor(bgB / edgePixels.length);
            
            console.log('检测到背景色:', `rgb(${bgR}, ${bgG}, ${bgB})`);
            
            // 转换到HSV色彩空间进行更精确的色度键处理
            const bgHsv = rgbToHsv(bgR, bgG, bgB);
            
            // 处理每个像素
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 转换到HSV
                const pixelHsv = rgbToHsv(r, g, b);
                
                // 计算色度差异
                const hueDiff = Math.abs(pixelHsv.h - bgHsv.h);
                const satDiff = Math.abs(pixelHsv.s - bgHsv.s);
                const valDiff = Math.abs(pixelHsv.v - bgHsv.v);
                
                // 色度键阈值
                const hueThreshold = 30; // 色相阈值
                const satThreshold = 0.3; // 饱和度阈值
                const valThreshold = 0.3; // 明度阈值
                
                // 判断是否为背景
                const isBackground = (
                    (hueDiff < hueThreshold || hueDiff > (360 - hueThreshold)) &&
                    satDiff < satThreshold &&
                    valDiff < valThreshold
                );
                
                if (isBackground) {
                    // 背景 - 设为透明
                    newData[i + 3] = 0;
                } else {
                    // 前景 - 保持不透明
                    newData[i + 3] = 255;
                }
            }
            
            console.log('色度键处理完成');
            return newData;
        }
        
        // RGB转HSV辅助函数
        function rgbToHsv(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const diff = max - min;
            
            let h = 0;
            if (diff !== 0) {
                if (max === r) {
                    h = ((g - b) / diff) % 6;
                } else if (max === g) {
                    h = (b - r) / diff + 2;
                } else {
                    h = (r - g) / diff + 4;
                }
            }
            h = Math.round(h * 60);
            if (h < 0) h += 360;
            
            const s = max === 0 ? 0 : diff / max;
            const v = max;
            
            return { h: h, s: s, v: v };
        }
        
        // 测试基本功能
        function testBasicFunction() {
            console.log('testBasicFunction called');
            alert('测试基本功能被调用！');
            
            if (!isImageLoaded) {
                alert('没有图片加载');
                return;
            }
            
            if (!imagePreview.src) {
                alert('图片源为空');
                return;
            }
            
            alert('图片状态正常，开始测试...');
            
            // 创建一个简单的测试图片
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 200;
            canvas.height = 200;
            
            // 填充红色背景
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 200, 200);
            
            // 绘制一个蓝色圆圈
            ctx.fillStyle = '#0000ff';
            ctx.beginPath();
            ctx.arc(100, 100, 50, 0, 2 * Math.PI);
            ctx.fill();
            
            // 更新图片
            const newImageData = canvas.toDataURL();
            console.log('Test image created:', newImageData.length);
            
            // 先销毁 cropper 实例
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            imagePreview.src = newImageData;
            currentImage = newImageData;
            
            // 重新初始化 cropper
            setTimeout(() => {
                initCropper();
            }, 100);
            
            alert('测试图片已应用！');
        }
        
        // AI智能抠图功能 - 使用免费API
        function removeBackgroundAI() {
            console.log('removeBackgroundAI called');
            
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            showNotification('正在使用AI进行智能抠图，请稍候...', 'info');
            
            // 将图片转换为Blob
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob(function(blob) {
                    // 使用免费的remove.bg API
                    const formData = new FormData();
                    formData.append('image_file', blob, 'image.jpg');
                    
                    // 使用免费的API端点
                    fetch('https://api.remove.bg/v1.0/removebg', {
                        method: 'POST',
                        headers: {
                            'X-Api-Key': 'YOUR_API_KEY_HERE' // 需要替换为真实的API密钥
                        },
                        body: formData
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('API调用失败，使用本地算法');
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        updateImageWithNewBackground(url);
                    })
                    .catch(error => {
                        console.log('API调用失败，使用本地算法:', error);
                        // 如果API失败，使用本地算法
                        useLocalRemoval();
                    });
                }, 'image/jpeg', 0.9);
            };
            
            img.src = imagePreview.src;
        }
        
        // 使用本地算法作为备选
        function useLocalRemoval() {
            console.log('使用本地抠图算法');
            showNotification('使用本地算法进行抠图...', 'info');
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const data = imageData.data;
                
                // 保存原始图像数据
                originalImageData = new ImageData(
                    new Uint8ClampedArray(data),
                    imageData.width,
                    imageData.height
                );
                
                // 使用改进的本地算法
                const processedData = improvedLocalRemoval(data, canvas.width, canvas.height);
                const processedImageData = new ImageData(processedData, canvas.width, canvas.height);
                
                ctx.putImageData(processedImageData, 0, 0);
                const newImageData = canvas.toDataURL();
                
                updateImageWithNewBackground(newImageData);
            };
            
            img.src = imagePreview.src;
        }
        
        // 改进的本地抠图算法
        function improvedLocalRemoval(data, width, height) {
            const newData = new Uint8ClampedArray(data);
            
            // 分析边缘像素确定背景色
            const edgePixels = [];
            const sampleSize = Math.min(20, Math.floor(Math.min(width, height) / 10));
            
            for (let i = 0; i < sampleSize; i++) {
                const x = Math.floor((i / sampleSize) * width);
                const y = Math.floor((i / sampleSize) * height);
                
                edgePixels.push({ x: x, y: 0 });
                edgePixels.push({ x: x, y: height - 1 });
                edgePixels.push({ x: 0, y: y });
                edgePixels.push({ x: width - 1, y: y });
            }
            
            // 计算背景色
            let bgR = 0, bgG = 0, bgB = 0;
            edgePixels.forEach(pixel => {
                const index = (pixel.y * width + pixel.x) * 4;
                bgR += data[index];
                bgG += data[index + 1];
                bgB += data[index + 2];
            });
            
            bgR = Math.floor(bgR / edgePixels.length);
            bgG = Math.floor(bgG / edgePixels.length);
            bgB = Math.floor(bgB / edgePixels.length);
            
            console.log('检测到背景色:', `rgb(${bgR}, ${bgG}, ${bgB})`);
            
            // 使用更智能的阈值
            const threshold = 40;
            
            // 处理每个像素
            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                const distance = Math.sqrt(
                    Math.pow(r - bgR, 2) + 
                    Math.pow(g - bgG, 2) + 
                    Math.pow(b - bgB, 2)
                );
                
                if (distance < threshold) {
                    newData[i + 3] = 0; // 透明
                } else {
                    newData[i + 3] = 255; // 不透明
                }
            }
            
            return newData;
        }
        
        // 更新图片并应用新背景
        function updateImageWithNewBackground(imageUrl) {
            console.log('更新图片:', imageUrl);
            
            // 先销毁 cropper 实例
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            
            imagePreview.src = imageUrl;
            currentImage = imageUrl;
            isBackgroundRemoved = true;
            
            // 重新初始化 cropper
            setTimeout(() => {
                initCropper();
            }, 100);
            
            showNotification('AI抠图完成！现在可以选择背景颜色', 'success');
        }
        
        // 打开在线抠图网站
        function openRemoveBgWebsite() {
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            // 创建一个临时的下载链接
            const link = document.createElement('a');
            link.href = imagePreview.src;
            link.download = 'image_for_removal.jpg';
            link.click();
            
            // 打开在线抠图网站
            const websites = [
                'https://www.remove.bg/',
                'https://www.photopea.com/',
                'https://www.canva.com/',
                'https://www.figma.com/'
            ];
            
            const randomSite = websites[Math.floor(Math.random() * websites.length)];
            window.open(randomSite, '_blank');
            
            showNotification('图片已下载，请使用在线工具抠图后重新上传', 'info');
        }
        
        // 压缩工具功能
        let originalFileSize = 0;
        let currentImageWidth = 0;
        let currentImageHeight = 0;
        
        // 计算文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 更新文件大小预览
        function updateFileSizePreview() {
            if (!isImageLoaded || !imagePreview.src) return;
            
            // 计算原始文件大小
            const originalData = imagePreview.src.split(',')[1];
            originalFileSize = Math.round((originalData.length * 3) / 4);
            
            // 获取当前滑块值
            const quality = parseInt(compressionQualitySlider.value);
            const width = parseInt(widthSlider.value);
            const height = parseInt(heightSlider.value);
            
            // 计算压缩后的预计大小
            const compressionFactor = quality / 100;
            const sizeFactor = (width * height) / (currentImageWidth * currentImageHeight);
            const estimatedSize = Math.round(originalFileSize * compressionFactor * sizeFactor);
            
            // 更新显示
            if (originalSize) originalSize.textContent = formatFileSize(originalFileSize);
            if (compressedSize) compressedSize.textContent = formatFileSize(estimatedSize);
            
            const ratio = ((originalFileSize - estimatedSize) / originalFileSize * 100).toFixed(1);
            if (compressionRatio) compressionRatio.textContent = ratio + '%';
            
            // 更新进度条
            const sizePercentage = Math.min(100, (estimatedSize / originalFileSize) * 100);
            if (sizeBarFill) sizeBarFill.style.width = sizePercentage + '%';
            
            // 更新滑块标签
            if (widthValue) widthValue.textContent = width === 1000 ? '原始' : width + 'px';
            if (heightValue) heightValue.textContent = height === 1000 ? '原始' : height + 'px';
        }
        
        // 应用压缩
        function applyCompression() {
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            const quality = parseInt(compressionQualitySlider.value) / 100;
            const width = parseInt(widthSlider.value);
            const height = parseInt(heightSlider.value);
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // 设置画布尺寸
                canvas.width = width;
                canvas.height = height;
                
                // 绘制图片
                ctx.drawImage(img, 0, 0, width, height);
                
                // 转换为指定质量的图片
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // 更新图片
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                imagePreview.src = compressedDataUrl;
                currentImage = compressedDataUrl;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                // 保存到历史记录
                saveToHistory(compressedDataUrl);
                
                // 更新文件大小预览
                updateFileSizePreview();
                
                showNotification('压缩完成！', 'success');
            };
            
            img.src = imagePreview.src;
        }
        
        // 重置压缩设置
        function resetCompression() {
            compressionQualitySlider.value = 85;
            widthSlider.value = 1000;
            heightSlider.value = 1000;
            
            compressionQualityValue.textContent = '85%';
            widthValue.textContent = '原始';
            heightValue.textContent = '原始';
            
            updateFileSizePreview();
        }
        
        // 确保函数在全局作用域中可用
        window.applyCompression = applyCompression;
        window.resetCompression = resetCompression;
        
        // 初始化语言
        function initLanguage() {
            const savedLang = localStorage.getItem('preferredLanguage') || 'zh';
            changeLanguage(savedLang);
        }
        
        // 移动端菜单功能
        function initMobileMenu() {
            // 复制侧边栏内容到移动端菜单
            const sidebar = document.querySelector('.sidebar');
            if (sidebar && mobileSidebarContent) {
                mobileSidebarContent.innerHTML = sidebar.innerHTML;
            }
            
            // 移动端菜单按钮事件
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileSidebar.classList.add('show');
                    mobileOverlay.classList.add('show');
                    document.body.style.overflow = 'hidden';
                });
            }
            
            // 关闭移动端菜单
            function closeMobileMenu() {
                mobileSidebar.classList.remove('show');
                mobileOverlay.classList.remove('show');
                document.body.style.overflow = '';
            }
            
            if (mobileSidebarClose) {
                mobileSidebarClose.addEventListener('click', closeMobileMenu);
            }
            
            if (mobileOverlay) {
                mobileOverlay.addEventListener('click', closeMobileMenu);
            }
            
            // 重新绑定移动端菜单中的事件
            bindMobileMenuEvents();
        }
        
        // 绑定移动端菜单中的事件
        function bindMobileMenuEvents() {
            // 重新绑定背景颜色事件
            const mobileBgColorOptions = mobileSidebarContent.querySelectorAll('.bg-color-option');
            mobileBgColorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    console.log('Mobile background color clicked:', option.getAttribute('data-color'));
                    // 更新主界面的背景颜色选择
                    const mainBgColorOptions = document.querySelectorAll('.bg-color-option');
                    mainBgColorOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    
                    // 同步到主界面
                    const mainOption = document.querySelector(`.bg-color-option[data-color="${option.getAttribute('data-color')}"]`);
                    if (mainOption) {
                        mainOption.classList.add('active');
                    }
                    
                    selectedBgColor = option.getAttribute('data-color');
                    console.log('Selected background color:', selectedBgColor);
                    closeMobileMenu();
                });
            });
            
            // 绑定抠图相关按钮事件
            const mobileRemoveBgBtn = mobileSidebarContent.querySelector('button[onclick="removeBackground()"]');
            if (mobileRemoveBgBtn) {
                mobileRemoveBgBtn.addEventListener('click', () => {
                    removeBackground();
                    closeMobileMenu();
                });
            }
            
            const mobileApplyBgBtn = mobileSidebarContent.querySelector('button[onclick="applyBackgroundColor()"]');
            if (mobileApplyBgBtn) {
                mobileApplyBgBtn.addEventListener('click', () => {
                    applyBackgroundColor();
                    closeMobileMenu();
                });
            }
            
            const mobileRestoreBtn = mobileSidebarContent.querySelector('button[onclick="restoreOriginalImage()"]');
            if (mobileRestoreBtn) {
                mobileRestoreBtn.addEventListener('click', () => {
                    restoreOriginalImage();
                    closeMobileMenu();
                });
            }
            
            // 重新绑定所有按钮事件
            const mobileButtons = mobileSidebarContent.querySelectorAll('.btn, .action-btn, .format-btn, .filter-option, .id-photo-option');
            mobileButtons.forEach(button => {
                // 移除旧的事件监听器
                const newButton = button.cloneNode(true);
                button.parentNode.replaceChild(newButton, button);
                
                // 根据按钮类型绑定相应事件
                if (newButton.classList.contains('format-btn')) {
                    newButton.addEventListener('click', () => {
                        formatOptions.forEach(opt => opt.classList.remove('active'));
                        newButton.classList.add('active');
                        selectedFormat = newButton.getAttribute('data-format');
                        closeMobileMenu();
                    });
                } else if (newButton.classList.contains('id-photo-option')) {
                    newButton.addEventListener('click', () => {
                        idPhotoOptions.forEach(opt => opt.classList.remove('active'));
                        newButton.classList.add('active');
                        selectedIdPhotoSize = newButton.getAttribute('data-size');
                        selectedIdPhotoRatio = parseFloat(newButton.getAttribute('data-ratio'));
                        
                        if (cropper && isImageLoaded) {
                            cropper.setAspectRatio(selectedIdPhotoRatio);
                        }
                        closeMobileMenu();
                    });
                } else if (newButton.classList.contains('filter-option')) {
                    newButton.addEventListener('click', () => {
                        filterOptions.forEach(opt => opt.classList.remove('active'));
                        newButton.classList.add('active');
                        selectedFilter = newButton.getAttribute('data-filter');
                        
                        if (isImageLoaded) {
                            applyFilter(selectedFilter);
                        }
                        closeMobileMenu();
                    });
                } else if (newButton.id) {
                    // 绑定特定功能按钮
                    const originalButton = document.getElementById(newButton.id);
                    if (originalButton) {
                        newButton.addEventListener('click', () => {
                            originalButton.click();
                            closeMobileMenu();
                        });
                    }
                }
            });
            
            // 重新绑定滑块事件
            const mobileSliders = mobileSidebarContent.querySelectorAll('.slider');
            mobileSliders.forEach(slider => {
                const originalSlider = document.getElementById(slider.id);
                if (originalSlider) {
                    slider.addEventListener('input', (e) => {
                        originalSlider.value = e.target.value;
                        originalSlider.dispatchEvent(new Event('input'));
                    });
                }
            });
        }
        
        // 关闭移动端菜单的函数
        function closeMobileMenu() {
            mobileSidebar.classList.remove('show');
            mobileOverlay.classList.remove('show');
            document.body.style.overflow = '';
        }
        
        // 上传区域点击事件
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        // 文件选择事件
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // 检查文件大小（限制为10MB）
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(translations[currentLang]['file_too_large'] || '文件过大，请选择小于10MB的图片', 'error');
                    return;
                }
                
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    showNotification(translations[currentLang]['invalid_file_type'] || '请选择有效的图片文件', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        // 保存原始图片
                        originalImage = event.target.result;
                        currentImage = event.target.result;
                        
                        // 显示图片
                        imagePreview.src = event.target.result;
                        imagePreview.style.display = 'block';
                        placeholder.style.display = 'none';
                        
                        // 初始化裁剪器
                        initCropper();
                        
                        // 初始化压缩工具
                        currentImageWidth = imagePreview.naturalWidth;
                        currentImageHeight = imagePreview.naturalHeight;
                        widthSlider.max = currentImageWidth;
                        heightSlider.max = currentImageHeight;
                        widthSlider.value = currentImageWidth;
                        heightSlider.value = currentImageHeight;
                        updateFileSizePreview();
                        
                        // 初始化裁剪信息
                        updateCropInfo();
                        
                        // 保存到历史记录
                        saveToHistory(event.target.result);
                        
                        isImageLoaded = true;
                        updateButtonStates();
                        
                        showNotification(translations[currentLang]['upload_success']);
                    } catch (error) {
                        console.error('图片加载失败:', error);
                        showNotification(translations[currentLang]['image_load_error'] || '图片加载失败，请重试', 'error');
                    }
                };
                
                reader.onerror = () => {
                    showNotification(translations[currentLang]['file_read_error'] || '文件读取失败，请重试', 'error');
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        // 初始化裁剪器
        function initCropper() {
            if (cropper) {
                cropper.destroy();
            }
            
            cropper = new Cropper(imagePreview, {
                aspectRatio: selectedIdPhotoRatio,
                viewMode: 1,
                guides: true,
                background: false,
                autoCropArea: 0.8,
                responsive: true,
                restore: true,
                checkCrossOrigin: false
            });
        }
        
        // 更新按钮状态
        function updateButtonStates() {
            const buttons = document.querySelectorAll('.btn, .action-btn');
            buttons.forEach(btn => {
                if (btn.id !== 'helpBtn' && btn.id !== 'resetBtn') {
                    btn.disabled = !isImageLoaded;
                }
            });
            
            // 重置按钮特殊处理
            resetBtn.disabled = !isImageLoaded;
        }
        
        // 格式选择事件
        formatOptions.forEach(option => {
            option.addEventListener('click', () => {
                formatOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedFormat = option.getAttribute('data-format');
            });
        });
        
        // 证件照尺寸选择事件
        idPhotoOptions.forEach(option => {
            option.addEventListener('click', () => {
                idPhotoOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedIdPhotoSize = option.getAttribute('data-size');
                selectedIdPhotoRatio = parseFloat(option.getAttribute('data-ratio'));
                
                if (cropper && isImageLoaded) {
                    cropper.setAspectRatio(selectedIdPhotoRatio);
                }
            });
        });
        
        // 背景颜色选择事件
        function bindBgColorEvents() {
            const bgColorOptions = document.querySelectorAll('.bg-color-option');
            console.log('Found bg color options:', bgColorOptions.length);
            
            bgColorOptions.forEach(option => {
                option.addEventListener('click', () => {
                    console.log('Background color clicked:', option.getAttribute('data-color'));
                    bgColorOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    selectedBgColor = option.getAttribute('data-color');
                    console.log('Selected background color:', selectedBgColor);
                });
            });
        }
        
        // 初始化背景颜色事件
        bindBgColorEvents();
        
        // 滤镜选择事件
        filterOptions.forEach(option => {
            option.addEventListener('click', () => {
                filterOptions.forEach(opt => opt.classList.remove('active'));
                option.classList.add('active');
                selectedFilter = option.getAttribute('data-filter');
                
                if (isImageLoaded) {
                    applyFilter(selectedFilter);
                }
            });
        });
        
        
        
        // 应用裁剪按钮事件
        applyCropBtn.addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            // 获取裁剪后的图片
            const canvas = cropper.getCroppedCanvas();
            currentImage = canvas.toDataURL(`image/${selectedFormat}`);
            imagePreview.src = currentImage;
            
            // 重新初始化裁剪器
            initCropper();
            
            const sizeNames = {
                '1inch': translations[currentLang]['1inch_photo'],
                '2inch': translations[currentLang]['2inch_photo'],
                'small2inch': translations[currentLang]['small2inch_photo'],
                'large1inch': translations[currentLang]['large1inch_photo']
            };
            
            showNotification(`${translations[currentLang]['crop_applied']} ${sizeNames[selectedIdPhotoSize]}`);
        });
        
        // 下载证件照按钮事件
        downloadIdPhotoBtn.addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            // 创建Canvas处理证件照
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置证件照尺寸 (以像素为单位)
            const idPhotoSizes = {
                '1inch': { width: 295, height: 413 }, // 2.5×3.5cm @ 300dpi
                '2inch': { width: 413, height: 579 }, // 3.5×4.9cm @ 300dpi
                'small2inch': { width: 390, height: 567 }, // 3.3×4.8cm @ 300dpi
                'large1inch': { width: 472, height: 650 } // 4.0×5.5cm @ 300dpi
            };
            
            const size = idPhotoSizes[selectedIdPhotoSize];
            canvas.width = size.width;
            canvas.height = size.height;
            
            // 填充背景色
            ctx.fillStyle = selectedBgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制图片
            const img = new Image();
            img.onload = function() {
                // 计算图片在证件照中的位置和尺寸
                const croppedCanvas = cropper.getCroppedCanvas();
                const scale = Math.min(canvas.width / croppedCanvas.width, canvas.height / croppedCanvas.height);
                const x = (canvas.width - croppedCanvas.width * scale) / 2;
                const y = (canvas.height - croppedCanvas.height * scale) / 2;
                
                ctx.drawImage(croppedCanvas, x, y, croppedCanvas.width * scale, croppedCanvas.height * scale);
                
                // 下载图片
                const link = document.createElement('a');
                link.download = `id_photo_${selectedIdPhotoSize}.${selectedFormat}`;
                link.href = canvas.toDataURL(`image/${selectedFormat}`);
                link.click();
                
                showNotification(translations[currentLang]['id_photo_downloaded']);
            };
            img.src = currentImage;
        });
        
        // 下载按钮事件
        downloadBtn.addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            // 创建虚拟链接进行下载
            const link = document.createElement('a');
            link.download = `edited_image.${selectedFormat}`;
            link.href = currentImage;
            link.click();
            
            showNotification(translations[currentLang]['download_success']);
        });
        
        // 重置按钮事件
        resetBtn.addEventListener('click', () => {
            if (isImageLoaded) {
                currentImage = originalImage;
                imagePreview.src = originalImage;
                
                // 重新初始化裁剪器
                initCropper();
                
                // 重置滤镜
                filterOptions.forEach(opt => opt.classList.remove('active'));
                document.querySelector('[data-filter="none"]').classList.add('active');
                selectedFilter = 'none';
                
                // 应用无滤镜
                imagePreview.style.filter = 'none';
                
                showNotification(translations[currentLang]['image_reset']);
            } else {
                showNotification(translations[currentLang]['no_image_reset'], 'error');
            }
        });
        
        // 帮助按钮事件
        helpBtn.addEventListener('click', () => {
            showNotification(translations[currentLang]['help_message'], 'info');
        });
        
        
        
        
        compressionQualitySlider.addEventListener('input', () => {
            compressionQualityValue.textContent = compressionQualitySlider.value + '%';
            updateFileSizePreview();
        });
        
        widthSlider.addEventListener('input', () => {
            widthValue.textContent = widthSlider.value === '1000' ? '原始' : widthSlider.value + 'px';
            updateFileSizePreview();
        });
        
        heightSlider.addEventListener('input', () => {
            heightValue.textContent = heightSlider.value === '1000' ? '原始' : heightSlider.value + 'px';
            updateFileSizePreview();
        });
        
        // 压缩工具按钮事件
        applyCompressionBtn.addEventListener('click', applyCompression);
        resetCompressionBtn.addEventListener('click', resetCompression);
        
        // 历史记录按钮事件
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);
        document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
        
        
        // 自定义裁剪按钮事件
        document.getElementById('previewCropBtn').addEventListener('click', previewCrop);
        document.getElementById('applyCropBtn').addEventListener('click', applyPixelCrop);
        
        // 裁剪输入框事件
        document.getElementById('cropX').addEventListener('input', updateCropAreaInfo);
        document.getElementById('cropY').addEventListener('input', updateCropAreaInfo);
        document.getElementById('cropWidth').addEventListener('input', updateCropAreaInfo);
        document.getElementById('cropHeight').addEventListener('input', updateCropAreaInfo);
        
        // 快速设置按钮事件
        document.getElementById('cropCenterBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            const centerX = Math.floor(imagePreview.naturalWidth / 4);
            const centerY = Math.floor(imagePreview.naturalHeight / 4);
            const centerWidth = Math.floor(imagePreview.naturalWidth / 2);
            const centerHeight = Math.floor(imagePreview.naturalHeight / 2);
            
            document.getElementById('cropX').value = centerX;
            document.getElementById('cropY').value = centerY;
            document.getElementById('cropWidth').value = centerWidth;
            document.getElementById('cropHeight').value = centerHeight;
            
            updateCropAreaInfo();
            showNotification('已设置为居中裁剪区域');
        });
        
        document.getElementById('cropFullBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            document.getElementById('cropX').value = 0;
            document.getElementById('cropY').value = 0;
            document.getElementById('cropWidth').value = imagePreview.naturalWidth;
            document.getElementById('cropHeight').value = imagePreview.naturalHeight;
            
            updateCropAreaInfo();
            showNotification('已设置为全图裁剪区域');
        });
        
        document.getElementById('cropSquareBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            const size = Math.min(imagePreview.naturalWidth, imagePreview.naturalHeight);
            const centerX = Math.floor((imagePreview.naturalWidth - size) / 2);
            const centerY = Math.floor((imagePreview.naturalHeight - size) / 2);
            
            document.getElementById('cropX').value = centerX;
            document.getElementById('cropY').value = centerY;
            document.getElementById('cropWidth').value = size;
            document.getElementById('cropHeight').value = size;
            
            updateCropAreaInfo();
            showNotification('已设置为正方形裁剪区域');
        });
        
        // 自定义裁剪功能
        function updateCropInfo() {
            if (!isImageLoaded || !imagePreview.src) return;
            
            const currentImageSize = document.getElementById('currentImageSize');
            const cropAreaInfo = document.getElementById('cropAreaInfo');
            
            if (currentImageSize) {
                currentImageSize.textContent = `${imagePreview.naturalWidth} × ${imagePreview.naturalHeight}`;
            }
            
            // 设置输入框的最大值
            const cropX = document.getElementById('cropX');
            const cropY = document.getElementById('cropY');
            const cropWidth = document.getElementById('cropWidth');
            const cropHeight = document.getElementById('cropHeight');
            
            if (cropX) {
                cropX.max = imagePreview.naturalWidth - 1;
                cropX.placeholder = `0-${imagePreview.naturalWidth - 1}`;
            }
            if (cropY) {
                cropY.max = imagePreview.naturalHeight - 1;
                cropY.placeholder = `0-${imagePreview.naturalHeight - 1}`;
            }
            if (cropWidth) {
                cropWidth.max = imagePreview.naturalWidth;
                cropWidth.placeholder = `1-${imagePreview.naturalWidth}`;
            }
            if (cropHeight) {
                cropHeight.max = imagePreview.naturalHeight;
                cropHeight.placeholder = `1-${imagePreview.naturalHeight}`;
            }
            
            // 更新裁剪区域信息
            updateCropAreaInfo();
        }
        
        function updateCropAreaInfo() {
            const cropX = document.getElementById('cropX').value || 0;
            const cropY = document.getElementById('cropY').value || 0;
            const cropWidth = document.getElementById('cropWidth').value || 0;
            const cropHeight = document.getElementById('cropHeight').value || 0;
            
            const cropAreaInfo = document.getElementById('cropAreaInfo');
            if (cropAreaInfo) {
                cropAreaInfo.textContent = `${cropX}, ${cropY} - ${cropWidth} × ${cropHeight}`;
            }
        }
        
        // 预览裁剪
        function previewCrop() {
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            const x = parseInt(document.getElementById('cropX').value) || 0;
            const y = parseInt(document.getElementById('cropY').value) || 0;
            const width = parseInt(document.getElementById('cropWidth').value) || 100;
            const height = parseInt(document.getElementById('cropHeight').value) || 100;
            
            // 详细验证
            if (isNaN(x) || isNaN(y) || isNaN(width) || isNaN(height)) {
                showNotification('请输入有效的数字', 'error');
                return;
            }
            
            if (x < 0 || y < 0) {
                showNotification('坐标不能为负数', 'error');
                return;
            }
            
            if (width <= 0 || height <= 0) {
                showNotification('裁剪尺寸必须大于0', 'error');
                return;
            }
            
            if (x >= imagePreview.naturalWidth) {
                showNotification(`X坐标不能大于等于图片宽度(${imagePreview.naturalWidth})`, 'error');
                return;
            }
            
            if (y >= imagePreview.naturalHeight) {
                showNotification(`Y坐标不能大于等于图片高度(${imagePreview.naturalHeight})`, 'error');
                return;
            }
            
            if (x + width > imagePreview.naturalWidth) {
                showNotification(`裁剪区域超出图片宽度，最大X坐标: ${imagePreview.naturalWidth - width}`, 'error');
                return;
            }
            
            if (y + height > imagePreview.naturalHeight) {
                showNotification(`裁剪区域超出图片高度，最大Y坐标: ${imagePreview.naturalHeight - height}`, 'error');
                return;
            }
            
            // 创建canvas进行裁剪预览
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            
            const img = new Image();
            img.onload = function() {
                // 绘制裁剪区域
                ctx.drawImage(img, x, y, width, height, 0, 0, width, height);
                
                // 临时显示裁剪结果
                const tempPreview = document.createElement('img');
                tempPreview.src = canvas.toDataURL();
                tempPreview.style.position = 'fixed';
                tempPreview.style.top = '50%';
                tempPreview.style.left = '50%';
                tempPreview.style.transform = 'translate(-50%, -50%)';
                tempPreview.style.maxWidth = '80vw';
                tempPreview.style.maxHeight = '80vh';
                tempPreview.style.border = '2px solid #007bff';
                tempPreview.style.borderRadius = '8px';
                tempPreview.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
                tempPreview.style.zIndex = '1000';
                tempPreview.style.background = 'white';
                tempPreview.style.padding = '10px';
                
                // 添加关闭按钮
                const closeBtn = document.createElement('button');
                closeBtn.innerHTML = '×';
                closeBtn.style.position = 'absolute';
                closeBtn.style.top = '5px';
                closeBtn.style.right = '5px';
                closeBtn.style.background = '#dc3545';
                closeBtn.style.color = 'white';
                closeBtn.style.border = 'none';
                closeBtn.style.borderRadius = '50%';
                closeBtn.style.width = '30px';
                closeBtn.style.height = '30px';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.fontSize = '18px';
                
                const previewContainer = document.createElement('div');
                previewContainer.style.position = 'fixed';
                previewContainer.style.top = '0';
                previewContainer.style.left = '0';
                previewContainer.style.width = '100%';
                previewContainer.style.height = '100%';
                previewContainer.style.background = 'rgba(0,0,0,0.5)';
                previewContainer.style.zIndex = '999';
                previewContainer.style.display = 'flex';
                previewContainer.style.alignItems = 'center';
                previewContainer.style.justifyContent = 'center';
                
                previewContainer.appendChild(tempPreview);
                tempPreview.style.position = 'relative';
                tempPreview.appendChild(closeBtn);
                document.body.appendChild(previewContainer);
                
                // 点击关闭
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(previewContainer);
                });
                
                previewContainer.addEventListener('click', (e) => {
                    if (e.target === previewContainer) {
                        document.body.removeChild(previewContainer);
                    }
                });
                
                showNotification('裁剪预览已显示，点击×关闭预览');
            };
            
            img.src = imagePreview.src;
        }
        
        // 应用精确裁剪
        function applyPixelCrop() {
            if (!isImageLoaded || !imagePreview.src) {
                showNotification('请先上传图片', 'error');
                return;
            }
            
            const x = parseInt(document.getElementById('cropX').value) || 0;
            const y = parseInt(document.getElementById('cropY').value) || 0;
            const width = parseInt(document.getElementById('cropWidth').value) || 100;
            const height = parseInt(document.getElementById('cropHeight').value) || 100;
            
            // 详细验证
            if (isNaN(x) || isNaN(y) || isNaN(width) || isNaN(height)) {
                showNotification('请输入有效的数字', 'error');
                return;
            }
            
            if (x < 0 || y < 0) {
                showNotification('坐标不能为负数', 'error');
                return;
            }
            
            if (width <= 0 || height <= 0) {
                showNotification('裁剪尺寸必须大于0', 'error');
                return;
            }
            
            if (x >= imagePreview.naturalWidth) {
                showNotification(`X坐标不能大于等于图片宽度(${imagePreview.naturalWidth})`, 'error');
                return;
            }
            
            if (y >= imagePreview.naturalHeight) {
                showNotification(`Y坐标不能大于等于图片高度(${imagePreview.naturalHeight})`, 'error');
                return;
            }
            
            if (x + width > imagePreview.naturalWidth) {
                showNotification(`裁剪区域超出图片宽度，最大X坐标: ${imagePreview.naturalWidth - width}`, 'error');
                return;
            }
            
            if (y + height > imagePreview.naturalHeight) {
                showNotification(`裁剪区域超出图片高度，最大Y坐标: ${imagePreview.naturalHeight - height}`, 'error');
                return;
            }
            
            // 创建canvas进行精确裁剪
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;
            
            const img = new Image();
            img.onload = function() {
                // 绘制裁剪区域
                ctx.drawImage(img, x, y, width, height, 0, 0, width, height);
                
                // 获取裁剪后的图片数据
                const croppedDataUrl = canvas.toDataURL(`image/${selectedFormat}`, 0.9);
                
                // 更新图片
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                
                imagePreview.src = croppedDataUrl;
                currentImage = croppedDataUrl;
                
                // 重新初始化 cropper
                setTimeout(() => {
                    initCropper();
                }, 100);
                
                // 保存到历史记录
                saveToHistory(croppedDataUrl);
                
                // 隐藏自定义裁剪面板
                document.getElementById('customCropPanel').style.display = 'none';
                
                showNotification(`裁剪完成！新尺寸: ${width} × ${height}`, 'success');
            };
            
            img.src = imagePreview.src;
        }
        
        // 其他编辑功能
        document.getElementById('cropSquareBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            if (cropper) {
                cropper.setAspectRatio(1);
                showNotification(translations[currentLang]['square_crop_set']);
            }
        });
        
        document.getElementById('cropCustomBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            // 显示自定义裁剪面板
            const customCropPanel = document.getElementById('customCropPanel');
            customCropPanel.style.display = customCropPanel.style.display === 'none' ? 'block' : 'none';
            
            if (customCropPanel.style.display === 'block') {
                // 初始化裁剪参数
                updateCropInfo();
                showNotification('请输入精确的像素值进行裁剪');
            }
        });
        
        document.getElementById('cropResetBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            if (cropper) {
                cropper.reset();
                showNotification(translations[currentLang]['crop_reset']);
            }
        });
        
        document.getElementById('rotateLeftBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            if (cropper) {
                cropper.rotate(-90);
                showNotification(translations[currentLang]['rotate_left_done']);
            }
        });
        
        document.getElementById('rotateRightBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            if (cropper) {
                cropper.rotate(90);
                showNotification(translations[currentLang]['rotate_right_done']);
            }
        });
        
        document.getElementById('flipHorizontalBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            if (cropper) {
                cropper.scaleX(-cropper.getData().scaleX || -1);
                showNotification(translations[currentLang]['flip_horizontal_done']);
            }
        });
        
        document.getElementById('flipVerticalBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            if (cropper) {
                cropper.scaleY(-cropper.getData().scaleY || -1);
                showNotification(translations[currentLang]['flip_vertical_done']);
            }
        });
        
        // 拖拽上传功能
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#f0f5ff';
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = 'white';
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = 'white';
            
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    // 保存原始图片
                    originalImage = event.target.result;
                    currentImage = event.target.result;
                    
                    // 显示图片
                    imagePreview.src = event.target.result;
                    imagePreview.style.display = 'block';
                    placeholder.style.display = 'none';
                    
                    // 初始化裁剪器
                    initCropper();
                    
                    // 初始化压缩工具
                    currentImageWidth = imagePreview.naturalWidth;
                    currentImageHeight = imagePreview.naturalHeight;
                    widthSlider.max = currentImageWidth;
                    heightSlider.max = currentImageHeight;
                    widthSlider.value = currentImageWidth;
                    heightSlider.value = currentImageHeight;
                    updateFileSizePreview();
                    
                    // 初始化裁剪信息
                    updateCropInfo();
                    
                    isImageLoaded = true;
                    updateButtonStates();
                    
                    showNotification(translations[currentLang]['upload_success']);
                };
                reader.readAsDataURL(file);
            } else {
                showNotification(translations[currentLang]['no_image_error'], 'error');
            }
        });
        
        // 语言切换功能
        languageBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Language button clicked');
            languageDropdown.classList.toggle('show');
        });
        
        // 点击页面其他地方关闭语言下拉菜单
        document.addEventListener('click', (e) => {
            if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.remove('show');
            }
        });
        
        // 简化语言选项事件绑定
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, language options should work with onclick');
        });
        
        // 显示通知函数
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            
            // 根据类型设置背景色
            if (type === 'error') {
                notification.style.background = '#dc3545';
            } else if (type === 'info') {
                notification.style.background = '#17a2b8';
            } else {
                notification.style.background = '#28a745';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // 新功能按钮事件
        document.getElementById('compressBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                const compressedImage = canvas.toDataURL(`image/${selectedFormat}`, 0.9);
                currentImage = compressedImage;
                imagePreview.src = compressedImage;
                
                saveToHistory(compressedImage);
                showNotification(translations[currentLang]['image_compressed'] || '图片已压缩');
            };
            img.src = currentImage;
        });
        
        document.getElementById('optimizeBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            
            // 智能优化：自动调整亮度、对比度、饱和度
            brightnessSlider.value = 110;
            contrastSlider.value = 105;
            saturationSlider.value = 110;
            
            brightnessValue.textContent = '110%';
            contrastValue.textContent = '105%';
            saturationValue.textContent = '110%';
            
            applyFilter(selectedFilter);
            showNotification(translations[currentLang]['image_optimized'] || '图片已智能优化');
        });
        
        // AI工具按钮事件
        document.getElementById('removeBgBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            showNotification(translations[currentLang]['ai_feature_coming'] || 'AI功能即将推出，敬请期待！', 'info');
        });
        
        document.getElementById('enhanceBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            showNotification(translations[currentLang]['ai_feature_coming'] || 'AI功能即将推出，敬请期待！', 'info');
        });
        
        document.getElementById('faceDetectBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            showNotification(translations[currentLang]['ai_feature_coming'] || 'AI功能即将推出，敬请期待！', 'info');
        });
        
        document.getElementById('autoCropBtn').addEventListener('click', () => {
            if (!isImageLoaded) {
                showNotification(translations[currentLang]['no_image_error'], 'error');
                return;
            }
            showNotification(translations[currentLang]['ai_feature_coming'] || 'AI功能即将推出，敬请期待！', 'info');
        });
        
        // 键盘导航支持
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z 撤销
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undo();
            }
            // Ctrl+Y 或 Ctrl+Shift+Z 重做
            else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                e.preventDefault();
                redo();
            }
            // Ctrl+S 保存/下载
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                if (isImageLoaded) {
                    downloadBtn.click();
                }
            }
            // Ctrl+R 重置
            else if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                if (isImageLoaded) {
                    resetBtn.click();
                }
            }
            // Escape 关闭语言下拉菜单
            else if (e.key === 'Escape') {
                languageDropdown.classList.remove('show');
            }
        });
        
        // 添加键盘可访问性
        document.querySelectorAll('.btn, .filter-option, .id-photo-option, .format-btn').forEach(element => {
            element.setAttribute('tabindex', '0');
            element.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    element.click();
                }
            });
        });
        
        // 初始化按钮状态
        updateButtonStates();
        
        // 初始化语言
        initLanguage();
        
        // 初始化移动端菜单
        initMobileMenu();
    </script>
</body>
</html>